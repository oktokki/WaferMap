<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Test Analytics - Semiconductor Value Chain ERP</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔬</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js"></script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Ensure CSS works - Critical styles inline */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f1f5f9; 
        }
        
        .main-tab.active { 
            border-color: #10b981 !important; 
            color: #10b981 !important; 
            background-color: #ecfdf5 !important; 
        }
        
        .main-tab { 
            border-color: transparent; 
            transition: all 0.2s ease;
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content:not(.hidden) { 
            display: block; 
        }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #10b981; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* File upload area hover effects */
        .upload-area:hover {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        
        /* Progress bar animations */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Chart container */
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 250px; 
        }
        
        /* Final test specific styles */
        .final-test-card {
            border-left: 4px solid #10b981;
        }
        
        .final-test-summary {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="dashboard-page" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white px-6 py-3 border-b flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">✅ Final Test Analytics</h1>
                    <p class="text-sm text-gray-600">Final test lotSumTXT and STDF data analysis</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">Semiconductor Value Chain ERP v5.0</span>
                <button onclick="generateReport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Generate Report
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="main-tabs" class="flex border-b bg-slate-50">
            <button data-tab="summary" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300 active">Summary</button>
            <button data-tab="file-upload" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300">File Upload</button>
            <button data-tab="final-test-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300">Final Test Analysis</button>
            <button data-tab="yield-comparison" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300">Yield Comparison</button>
            <button data-tab="lot-summary" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300">Lot Summary</button>
            <button data-tab="data-correlation" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-green-600 hover:border-green-300">Data Correlation</button>
        </nav>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Summary Tab -->
            <div id="summary-tab" class="tab-content">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">✅ Final Test Analytics</h1>
                    <p class="text-gray-600">Final test lotSumTXT and STDF data analysis with comprehensive yield correlation</p>
                </div>

                <!-- Quick Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Files</p>
                                <p id="summary-total-files" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-emerald-100 rounded-lg">
                                <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Final Test Yield</p>
                                <p id="summary-final-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Lots</p>
                                <p id="summary-total-lots" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-amber-100 rounded-lg">
                                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Tested Units</p>
                                <p id="summary-tested-units" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div class="final-test-summary p-6 rounded-lg border border-green-200">
                    <h2 class="text-xl font-semibold text-green-800 mb-3">✅ Final Test Analytics Dashboard</h2>
                    <p class="text-green-700 mb-4">
                        This dashboard provides comprehensive analysis tools for final test data including lotSumTXT files and STDF correlation analysis. 
                        Upload your test files to get started with detailed final test analytics and yield comparison.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📁 Multiple Formats</h3>
                            <p class="text-gray-600">Upload .lotSumTXT, .stdf files</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📊 Final Test Analysis</h3>
                            <p class="text-gray-600">Comprehensive yield and test correlation</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📈 Reports</h3>
                            <p class="text-gray-600">Export detailed final test reports</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Analysis Results -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Recent Final Test Analysis Results</h3>
                    </div>
                    <div class="p-6">
                        <div id="recent-results" class="text-center text-gray-500">
                            <p>Upload final test files to see comprehensive analysis results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="file-upload-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📁 Final Test File Upload</h1>
                    <p class="text-gray-600">Upload lotSumTXT, STDF files for comprehensive final test analysis</p>
                </div>

                <!-- File Upload Area -->
                <div class="mb-6">
                    <div id="upload-area" class="upload-area border-2 border-dashed border-gray-300 rounded-lg p-8 text-center bg-gray-50 hover:bg-green-50 transition-colors cursor-pointer">
                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Upload Final Test Files</h3>
                        <p class="text-gray-500 mb-4">Drag and drop files here or click to browse</p>
                        <p class="text-sm text-gray-400">Supported formats: .lotSumTXT, .stdf, .stdf.gz</p>
                        <input type="file" id="file-input" class="hidden" multiple accept=".lotSumTXT,.stdf,.gz">
                    </div>
                </div>

                <!-- Upload Controls -->
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <button id="select-files-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            📁 Select Files
                        </button>
                        <button id="clear-files-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">
                            🗑️ Clear All
                        </button>
                        <button id="analyze-files-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm disabled:bg-gray-400" disabled>
                            🔬 Analyze Data
                        </button>
                        <button id="export-results-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-sm disabled:bg-gray-400" disabled>
                            📊 Export Results
                        </button>
                        <div class="ml-auto">
                            <span class="text-sm text-gray-600">Total Files: <span id="total-files-count" class="font-semibold">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- File List -->
                <div class="mb-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Uploaded Files</h3>
                    </div>
                    <div class="p-6">
                        <div id="file-list" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                <p class="text-lg font-medium">No files uploaded yet</p>
                                <p class="text-sm text-gray-400">Upload final test files to begin analysis</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Progress -->
                <div id="analysis-progress" class="mb-6 bg-white rounded-lg shadow border hidden">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">⚡ Analysis Progress</h3>
                    </div>
                    <div class="p-6">
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Overall Progress</span>
                                <span id="overall-progress-text" class="text-sm text-gray-500">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="overall-progress-bar" class="progress-bar bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                            </div>
                            <div id="current-file-status" class="text-sm text-gray-600">
                                Ready to start analysis...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- File Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 File Types</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">lotSumTXT files</span>
                                <span id="lotsumtxt-count" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">STDF files</span>
                                <span id="stdf-count" class="font-semibold text-blue-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Compressed files</span>
                                <span id="compressed-count" class="font-semibold text-purple-600">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Analysis Status</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Processed</span>
                                <span id="processed-count" class="font-semibold text-green-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Processing</span>
                                <span id="processing-count" class="font-semibold text-yellow-600">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Pending</span>
                                <span id="pending-count" class="font-semibold text-gray-600">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">💾 Data Summary</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Total Size</span>
                                <span id="total-size" class="font-semibold">0 MB</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Records</span>
                                <span id="total-records" class="font-semibold">0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-sm text-gray-600">Last Upload</span>
                                <span id="last-upload" class="font-semibold">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Test Analysis Tab -->
            <div id="final-test-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">✅ Final Test Analysis Dashboard</h1>
                    <p class="text-gray-600">Comprehensive final test data analysis with lotSumTXT and STDF correlation</p>
                </div>

                <!-- Analysis Controls -->
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Type</label>
                            <select id="final-analysis-type" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="yield">Yield Analysis</option>
                                <option value="correlation">Data Correlation</option>
                                <option value="binning">Binning Analysis</option>
                                <option value="trend">Trend Analysis</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data Source</label>
                            <select id="data-source-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Sources</option>
                                <option value="lotsumtxt">lotSumTXT Only</option>
                                <option value="stdf">STDF Only</option>
                                <option value="combined">Combined Analysis</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Lot Filter</label>
                            <select id="lot-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Lots</option>
                            </select>
                        </div>
                        <button id="refresh-final-analysis" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Final Test Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border final-test-card">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Final Test Yield</p>
                                <p id="final-test-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border final-test-card">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Units Tested</p>
                                <p id="final-units-tested" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border final-test-card">
                        <div class="flex items-center">
                            <div class="p-2 bg-amber-100 rounded-lg">
                                <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Test Time</p>
                                <p id="final-test-time" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border final-test-card">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Defect Rate</p>
                                <p id="final-defect-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Yield Comparison Chart -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 Yield Comparison</h3>
                        <div class="chart-container">
                            <canvas id="yield-comparison-chart"></canvas>
                        </div>
                    </div>

                    <!-- Data Correlation Chart -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🔗 Data Correlation</h3>
                        <div class="chart-container">
                            <canvas id="data-correlation-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Final Test Results Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Final Test Results</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="final-test-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units Tested</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pass Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fail Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yield (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="final-test-tbody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                                        Upload and analyze files to view final test results
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Yield Comparison Tab -->
            <div id="yield-comparison-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📊 Yield Comparison Analysis</h1>
                    <p class="text-gray-600">Compare yields across different test stages and data sources</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Stage Comparison</h3>
                        <div class="chart-container">
                            <canvas id="stage-comparison-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🔄 Yield Correlation</h3>
                        <div class="chart-container">
                            <canvas id="yield-correlation-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Yield Comparison Table</h3>
                    </div>
                    <div class="p-6">
                        <div class="text-center text-gray-500">
                            <p>Upload and analyze files to view yield comparison data</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lot Summary Tab -->
            <div id="lot-summary-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📋 Lot Summary Analysis</h1>
                    <p class="text-gray-600">Comprehensive lot-level analysis and tracking</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Lots</h3>
                        <p id="lot-summary-total" class="text-3xl font-bold text-blue-600">--</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Average Yield</h3>
                        <p id="lot-summary-yield" class="text-3xl font-bold text-green-600">--</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">Total Units</h3>
                        <p id="lot-summary-units" class="text-3xl font-bold text-purple-600">--</p>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📊 Lot Details</h3>
                    </div>
                    <div class="p-6">
                        <div class="text-center text-gray-500">
                            <p>Upload files to view detailed lot summary</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Correlation Tab -->
            <div id="data-correlation-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">🔗 Data Correlation Analysis</h1>
                    <p class="text-gray-600">Analyze correlations between different test data sources</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 Correlation Matrix</h3>
                        <div class="chart-container">
                            <canvas id="correlation-matrix-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Trend Analysis</h3>
                        <div class="chart-container">
                            <canvas id="trend-analysis-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📊 Correlation Insights</h3>
                    </div>
                    <div class="p-6">
                        <div class="text-center text-gray-500">
                            <p>Upload and analyze files to view correlation insights</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Binning Analysis Tab -->
            <div id="binning-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📦 Binning Analysis Dashboard</h1>
                    <p class="text-gray-600">Advanced binning analysis and yield optimization insights</p>
                </div>

                <!-- Binning Analysis Controls -->
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bin Category</label>
                            <select id="bin-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Bins</option>
                                <option value="pass">Pass Bins</option>
                                <option value="fail">Fail Bins</option>
                                <option value="marginal">Marginal Bins</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Period</label>
                            <select id="bin-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="bin-sort-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="count">Count</option>
                                <option value="percentage">Percentage</option>
                                <option value="trend">Trend</option>
                            </select>
                        </div>
                        <button id="refresh-binning-analysis" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Binning Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Bins</p>
                                <p id="total-bins" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Pass Rate</p>
                                <p id="pass-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Fail Rate</p>
                                <p id="fail-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Marginal Rate</p>
                                <p id="marginal-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Binning Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Bin Distribution Chart -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 Bin Distribution</h3>
                        <div class="chart-container">
                            <canvas id="bin-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Bin Trend Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Bin Trend Analysis</h3>
                        <div class="chart-container">
                            <canvas id="bin-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Binning Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Binning Details</h3>
                    </div>
                    <div class="">
                        <table id="binning-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bin Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="binning-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Bin rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Binning Optimization Insights -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">💡 Binning Optimization Insights</h3>
                    </div>
                    <div id="binning-insights" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Yield Improvement Opportunities -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">🎯 Yield Improvement Opportunities</h4>
                                <div id="yield-opportunities" class="space-y-2">
                                    <!-- Opportunities will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Bin Consolidation Suggestions -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2">🔧 Bin Consolidation Suggestions</h4>
                                <div id="consolidation-suggestions" class="space-y-2">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RISK Assessment Tab -->
            <div id="risk-assessment-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">⚠️ Risk Assessment Dashboard</h1>
                    <p class="text-gray-600">Comprehensive risk analysis and quality control monitoring</p>
                </div>

                <!-- Risk Assessment Controls -->
                <div class="mb-6 p-4 bg-red-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                            <select id="risk-level-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Levels</option>
                                <option value="low">Low Risk</option>
                                <option value="medium">Medium Risk</option>
                                <option value="high">High Risk</option>
                                <option value="critical">Critical Risk</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                            <select id="risk-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Risk Category</label>
                            <select id="risk-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Categories</option>
                                <option value="yield">Yield Risk</option>
                                <option value="quality">Quality Risk</option>
                                <option value="process">Process Risk</option>
                                <option value="equipment">Equipment Risk</option>
                            </select>
                        </div>
                        <button id="refresh-risk-assessment" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Assessment
                        </button>
                    </div>
                </div>

                <!-- Risk Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Low Risk</p>
                                <p id="low-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Medium Risk</p>
                                <p id="medium-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">High Risk</p>
                                <p id="high-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Critical Risk</p>
                                <p id="critical-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Risk Trend Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Risk Trend Analysis</h3>
                        <div class="chart-container">
                            <canvas id="risk-trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Risk Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 Risk Distribution</h3>
                        <div class="chart-container">
                            <canvas id="risk-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Risk Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Risk Assessment Details</h3>
                    </div>
                    <div class="">
                        <table id="risk-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Probability</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="risk-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Risk rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Risk Mitigation Recommendations -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">💡 Risk Mitigation Recommendations</h3>
                    </div>
                    <div id="risk-mitigation" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Immediate Actions -->
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-2">🚨 Immediate Actions Required</h4>
                                <div id="immediate-actions" class="space-y-2">
                                    <!-- Immediate actions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Preventive Measures -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">🛡️ Preventive Measures</h4>
                                <div id="preventive-measures" class="space-y-2">
                                    <!-- Preventive measures will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Test Tab -->
            <div id="final-test-tab" class="tab-content hidden">
                <!-- File Upload Section -->
                <div class="mb-4">
                    <button id="uploadBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        파일 선택 및 업로드
                    </button>
                    <button id="debugBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded ml-2">
                        🔍 Debug Sequences
                    </button>
                    <button id="debugDataBtn" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded ml-2">
                        🔬 Debug Parsed Data
                    </button>
                </div>

                <!-- File Input -->
                <div class="mb-6">
                    <label class="block mb-2 font-semibold">Final Test Summary 파일 업로드 (.lotSumTXT)</label>
                    <input type="file" id="final-test-upload" accept=".lotSumTXT" multiple class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                    <p class="text-xs text-slate-500 mt-1">여러 Final Test 요약 파일을 업로드할 수 있습니다.</p>
                </div>

                <!-- Loading State -->
                <div id="final-test-loading" class="hidden text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-slate-600">파일을 분석 중입니다...</p>
                </div>

                <!-- Results Section -->
                <div id="final-test-result" class="hidden">
                    <!-- Multi-File Summary -->
                    <div id="multi-file-summary" class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h2 class="text-lg font-bold mb-2 text-blue-800">📊 Multi-File Summary</h2>
                        <div id="file-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
                        <div id="aggregated-yield" class="bg-white p-3 rounded shadow">
                            <h3 class="font-semibold mb-2">Aggregated Yield Analysis</h3>
                            <div id="aggregated-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                            <div class="mt-4 flex gap-2">
                                <button id="export-summary" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                    📊 Export Summary
                                </button>
                                <button id="export-details" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                                    📋 Export Details
                                </button>
                                <button id="export-comparison" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                                    📈 Export Comparison
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lot Comparison -->
                    <div id="lot-comparison" class="mb-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-bold text-green-800">📈 Lot Comparison</h2>
                            <div class="flex items-center space-x-2">
                                <button id="reset-table-width" class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                    🔄 Reset Width
                                </button>
                                <button id="fit-content-width" class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                    📏 Fit Content
                                </button>
                                <button id="print-friendly-width" class="px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                                    🖨️ Print Width
                                </button>
                            </div>
                        </div>
                        <div id="lot-comparison-table-container" class="bg-white rounded-lg border relative">
                            <div class="resize-handle absolute right-0 top-0 bottom-0 w-1 bg-gray-300 cursor-col-resize hover:bg-blue-400 transition-colors"></div>
                            <div class="overflow-x-auto" style="max-width: 1200px; min-width: 800px;">
                                <table id="lot-comparison-table" class="w-full text-sm table-fixed">
                                    <!-- Table content -->
                                </table>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-600">
                            💡 <strong>Tip:</strong> Drag the right edge to resize table width. Use buttons above for preset widths.
                        </div>
                    </div>
                    
                    <!-- Selected Lot Details Section -->
                    <div id="selected-lot-section" class="mt-6 hidden">
                        <!-- Lot Specific Analytics -->
                        <div class="p-6 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl border border-gray-200 shadow-lg">
                            <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                                <span class="text-3xl mr-3">🔍</span>
                                Lot Specific Analytics
                            </h2>
                            
                            <!-- Zone 1: Lot Info, Test Summary, Quality Metrics -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                <div id="selected-lot-info"></div>
                                <div id="selected-lot-summary"></div>
                                <div id="selected-lot-quality"></div>
                            </div>
                            
                            <!-- Zone 2: Re-test Flow, Failure Analysis -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div id="selected-lot-retest-flow"></div>
                                <div id="selected-lot-failure-analysis"></div>
                            </div>
                        </div>

                        <!-- Lot Hard Bin Sorting Table -->
                        <div id="hard-bin-table-container" class="mt-6">
                            <div class="bg-white rounded-lg shadow border">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold text-gray-800">📊 Hard Bin Sorting Table</h3>
                                </div>
                                <div class="">
                                    <table id="hard-bin-table" class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bin Code</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hard-bin-tbody" class="bg-white divide-y divide-gray-200">
                                            <!-- Hard bin data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Test Results by Site -->
                        <div class="mt-6">
                            <h2 class="text-lg font-bold mb-2 text-gray-700">📋 Test 결과 상세 (Site별)</h2>
                            <div id="test-stage-tabs" class="border-b border-gray-200 mb-2 flex space-x-4">
                                <!-- Test stage tabs will be injected here -->
                            </div>
                            <div id="test-results-container">
                                <!-- Test results tables will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Aggregated Enhanced Analytics -->
                    <div id="enhanced-analytics" class="mt-6 mb-6 p-4 bg-purple-50 rounded-lg">
                        <h2 class="text-lg font-bold mb-2 text-purple-800">🔬 Aggregated Enhanced Analytics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">📈 Yield Trend Analysis</h3>
                                <div id="trend-content"></div>
                            </div>
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">🎯 Failure Pattern Analysis</h3>
                                <div id="pattern-content"></div>
                            </div>
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">🏭 Site Performance</h3>
                                <div id="site-content"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">🔗 Failure Correlation Analysis</h3>
                                <div id="correlation-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Debug Information -->
                <div id="debug-info" class="mt-4 p-4 bg-gray-100 rounded text-xs hidden">
                    <h3 class="font-semibold mb-2">Debug Information:</h3>
                    <pre id="debug-content"></pre>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script type="module">
        // Import modules
        import { STDFFileHandler } from './js/STDFFileHandler.js';
        import { Analytics } from './js/modules/Analytics.js';
        import { UI } from './js/modules/UI.js';
        import { FileUtils } from './js/utils/FileUtils.js';
        import { CalculationUtils } from './js/utils/CalculationUtils.js';
        import { TestAnalysis } from './js/modules/TestAnalysis.js';
        import { BinningAnalysis } from './js/modules/BinningAnalysis.js';

        window.TestAnalysis = TestAnalysis;
        window.BinningAnalysis = BinningAnalysis;

        // Global variables
        let stdfHandler;
        let allData = [];
        let ui;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Initializing Wafer Map Dashboard v4.1 ===');
            
            // Initialize STDFFileHandler
            if (typeof STDFFileHandler !== 'undefined') {
                stdfHandler = new STDFFileHandler();
                console.log('✅ STDFFileHandler initialized successfully');
            } else {
                console.error('❌ STDFFileHandler failed to load');
                return;
            }

            // Initialize UI
            ui = new UI();
            console.log('✅ UI initialized successfully');

            // Initialize global functions for backward compatibility
            window.handleFileUpload = handleFileUpload;
            window.selectLot = (lotNumber) => ui.selectLot(lotNumber);
            window.getAggregatedAnalytics = () => Analytics.getAggregatedAnalytics(allData);
            window.generateExportData = generateExportData;

            console.log('✅ Application initialization complete');

            // Initialize tab switching
            initializeTabSwitching();
        });

        // File upload handler
        async function handleFileUpload(files) {
            console.log('=== File Upload Handler ===');
            console.log('Files to process:', files.length);

            // Clear previous data
            allData = [];
            
            // Show loading state
            ui.showLoadingState();

            try {
                // Process each file
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    console.log(`Processing file ${i + 1}/${files.length}: ${file.name}`);
                    
                    try {
                        const data = await stdfHandler.loadFile(file);
                        console.log(`File ${file.name} parse result:`, data);
                        
                        if (data && data.success) {
                            allData.push(data);
                            console.log(`File ${file.name} processed successfully`);
                        } else {
                            console.error(`Failed to process file: ${file.name} - ${data?.error || 'no data returned'}`);
                        }
                    } catch (fileError) {
                        console.error(`Error processing file ${file.name}:`, fileError);
                    }
                }

                console.log('All files processed. Total data entries:', allData.length);
                
                // Display results
                if (allData.length > 0) {
                    console.log('Displaying results...');
                    
                    try {
                        // Get aggregated analytics
                        const aggregatedAnalytics = Analytics.getAggregatedAnalytics(allData);
                        console.log('Aggregated analytics:', aggregatedAnalytics);
                        
                        // Display results using UI module
                        ui.displayMultiFileSummary(aggregatedAnalytics);
                        
                        // Transform data for analysis modules
                        const transformedData = transformDataForAnalysis(allData);
                        
                        // Initialize new analysis modules
                        const testAnalysis = new TestAnalysis();
                        const binningAnalysis = new BinningAnalysis();
                        
                        // Load data into analysis modules
                        testAnalysis.loadTestData(transformedData);
                        binningAnalysis.loadBinningData(transformedData);
                        
                        // Populate device filters
                        populateDeviceFilters(transformedData);
                        
                        // Make modules globally accessible
                        window.testAnalysis = testAnalysis;
                        window.binningAnalysis = binningAnalysis;
                        
                        console.log('✅ Test Analysis and Binning Analysis modules initialized');
                        console.log('All displays completed successfully');
                    } catch (displayError) {
                        console.error('Error in display functions:', displayError);
                        ui.showError(`Error displaying data: ${displayError.message}`);
                    }
                } else {
                    console.error('No valid data found in uploaded files');
                    ui.showError('No valid data found in uploaded files. Check console for details.');
                }
            } catch (e) {
                console.error('Error processing files:', e);
                ui.showError(`Error processing files: ${e.message}`);
            } finally {
                // Hide loading state
                ui.hideLoadingState();
            }
        }

        // Export data generator
        function generateExportData(type) {
            const aggregatedAnalytics = Analytics.getAggregatedAnalytics(allData);
            const sequences = aggregatedAnalytics.testSequences || {};
            
            switch (type) {
                case 'summary':
                    return generateSummaryData(aggregatedAnalytics, sequences);
                case 'details':
                    return generateDetailsData(aggregatedAnalytics, sequences);
                case 'comparison':
                    return generateComparisonData(aggregatedAnalytics, sequences);
                default:
                    return [];
            }
        }

        function generateSummaryData(aggregatedAnalytics, sequences) {
            const summaryData = [];
            summaryData.push(['Wafer Test Summary Report', '', '', '']);
            summaryData.push(['Generated:', new Date().toLocaleString(), '', '']);
            summaryData.push(['', '', '', '']);
            
            // Add summary statistics
            summaryData.push(['Summary Statistics', '', '', '']);
            summaryData.push(['Total Files', aggregatedAnalytics.totalFiles, '', '']);
            summaryData.push(['Total Lots', Object.keys(sequences).length, '', '']);
            summaryData.push(['Average Yield', aggregatedAnalytics.overallYield.toFixed(2) + '%', '', '']);
            summaryData.push(['', '', '', '']);
            
            // Add lot details
            summaryData.push(['Lot Details', '', '', '']);
            summaryData.push(['Lot Number', 'Device', 'Lot Size', 'Yield (%)', 'Good', 'Fail']);
            
            Object.entries(sequences).forEach(([lotNumber, sequence]) => {
                summaryData.push([
                    lotNumber,
                    sequence.device || 'N/A',
                    sequence.totalInput,
                    sequence.finalYield.toFixed(2) + '%',
                    sequence.totalPass,
                    sequence.totalFail
                ]);
            });
            
            return summaryData;
        }

        function generateDetailsData(aggregatedAnalytics, sequences) {
            const detailsData = [];
            detailsData.push(['Detailed Test Results Report', '', '', '', '', '', '']);
            detailsData.push(['Generated:', new Date().toLocaleString(), '', '', '', '', '']);
            detailsData.push(['', '', '', '', '', '', '']);
            
            // Add lot details
            Object.entries(sequences).forEach(([lotNumber, sequence]) => {
                detailsData.push(['', '', '', '', '', '', '']);
                detailsData.push([`Lot: ${lotNumber}`, '', '', '', '', '', '']);
                detailsData.push(['Device', sequence.device || 'N/A', '', '', '', '', '']);
                detailsData.push(['Lot Size', sequence.totalInput, '', '', '', '', '']);
                detailsData.push(['Final Yield', sequence.finalYield.toFixed(2) + '%', '', '', '', '', '']);
                detailsData.push(['Total Pass', sequence.totalPass, '', '', '', '', '']);
                detailsData.push(['Final Fail', sequence.totalFail, '', '', '', '', '']);
            });
            
            return detailsData;
        }

        function generateComparisonData(aggregatedAnalytics, sequences) {
            const comparisonData = [];
            comparisonData.push(['Lot Comparison Report', '', '', '', '', '', '']);
            comparisonData.push(['Generated:', new Date().toLocaleString(), '', '', '', '', '']);
            comparisonData.push(['', '', '', '', '', '', '']);
            
            // Add comparison table
            comparisonData.push(['Lot Number', 'Device', 'Lot Size', 'Yield (%)', 'Good', 'Fail', 'Status']);
            
            Object.entries(sequences).forEach(([lotNumber, sequence]) => {
                const yieldStatus = sequence.finalYield >= 95 ? 'Excellent' : 
                                   sequence.finalYield >= 90 ? 'Good' : 
                                   sequence.finalYield >= 80 ? 'Fair' : 'Poor';
                
                comparisonData.push([
                    lotNumber,
                    sequence.device || 'N/A',
                    sequence.totalInput,
                    sequence.finalYield.toFixed(2) + '%',
                    sequence.totalPass,
                    sequence.totalFail,
                    yieldStatus
                ]);
            });
            
            return comparisonData;
        }

        // Transform data for analysis modules
        function transformDataForAnalysis(allData) {
            const transformedData = [];
            
            allData.forEach(fileData => {
                if (fileData.success && fileData.data) {
                    const lotData = {
                        lotNumber: fileData.data.lotInfo?.lotNumber || 'Unknown',
                        device: fileData.data.lotInfo?.device || 'Unknown',
                        testDate: fileData.data.lotInfo?.testDate || new Date().toISOString(),
                        operator: fileData.data.lotInfo?.operator || 'Unknown',
                        testResults: []
                    };
                    
                    // Transform test results
                    if (fileData.data.testResults && Array.isArray(fileData.data.testResults)) {
                        fileData.data.testResults.forEach(test => {
                            const testResult = {
                                test: test.test || 'Unknown Test',
                                result: test.result || 'UNKNOWN',
                                time: test.time || 0,
                                site1: test.site1 || 0,
                                site2: test.site2 || 0,
                                site3: test.site3 || 0,
                                site4: test.site4 || 0,
                                total: test.total || 0
                            };
                            lotData.testResults.push(testResult);
                        });
                    }
                    
                    transformedData.push(lotData);
                }
            });
            
            console.log('Transformed data for analysis:', transformedData);
            return transformedData;
        }

        // Populate device filters
        function populateDeviceFilters(transformedData) {
            const devices = [...new Set(transformedData.map(lot => lot.device))].filter(device => device !== 'Unknown');
            
            // Populate Test Analysis device filter
            const testDeviceFilter = document.getElementById('device-filter');
            if (testDeviceFilter) {
                testDeviceFilter.innerHTML = '<option value="all">All Devices</option>';
                devices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device;
                    option.textContent = device;
                    testDeviceFilter.appendChild(option);
                });
            }
            
            console.log('Device filters populated:', devices);
        }

        // Tab switching logic
        function initializeTabSwitching() {
            const tabButtons = document.querySelectorAll('.main-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.remove('border-blue-500');
                        btn.classList.remove('text-blue-600');
                        btn.classList.add('border-transparent');
                        btn.classList.add('text-gray-500');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    this.classList.add('border-blue-500');
                    this.classList.add('text-blue-600');
                    this.classList.remove('border-transparent');
                    this.classList.remove('text-gray-500');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                        
                        // Trigger data refresh for analysis tabs
                        if (targetTab === 'test-analysis' && window.testAnalysis) {
                            console.log('Refreshing Test Analysis data...');
                            window.testAnalysis.refreshAnalysis();
                        } else if (targetTab === 'binning-analysis' && window.binningAnalysis) {
                            console.log('Refreshing Binning Analysis data...');
                            window.binningAnalysis.refreshAnalysis();
                        }
                    }
                });
            });
        }

        // Debug functions
        window.debugParsedData = function() {
            console.log('=== Debug Parsed Data ===');
            console.log('Total files loaded:', allData.length);
            
            allData.forEach((fileData, index) => {
                console.log(`\n--- File ${index + 1}: ${fileData.fileName} ---`);
                console.log('File success:', fileData.success);
                
                if (fileData.success && fileData.data) {
                    console.log('Lot Info:', fileData.data.lotInfo);
                    console.log('Summary:', fileData.data.summary);
                    console.log('Analytics:', fileData.data.analytics);
                    console.log('Test Results Count:', fileData.data.testResults ? fileData.data.testResults.length : 0);
                } else {
                    console.log('File error:', fileData.error);
                }
            });
        };

        window.debugSequences = function() {
            console.log('=== Debug Test Sequences ===');
            const aggregatedAnalytics = Analytics.getAggregatedAnalytics(allData);
            console.log('Test Sequences:', aggregatedAnalytics.testSequences);
        };

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // File upload event listener
            const fileInput = document.getElementById('final-test-upload');
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        handleFileUpload(files);
                    }
                });
            }

            // Export buttons
            const exportSummaryBtn = document.getElementById('export-summary');
            const exportDetailsBtn = document.getElementById('export-details');
            const exportComparisonBtn = document.getElementById('export-comparison');

            if (exportSummaryBtn) {
                exportSummaryBtn.addEventListener('click', function() {
                    const data = generateExportData('summary');
                    ui.exportToExcel(data, 'wafer-test-summary');
                });
            }

            if (exportDetailsBtn) {
                exportDetailsBtn.addEventListener('click', function() {
                    const data = generateExportData('details');
                    ui.exportToExcel(data, 'wafer-test-details');
                });
            }

            if (exportComparisonBtn) {
                exportComparisonBtn.addEventListener('click', function() {
                    const data = generateExportData('comparison');
                    ui.exportToExcel(data, 'wafer-test-comparison');
                });
            }

            // Debug buttons
            const debugBtn = document.getElementById('debugBtn');
            const debugDataBtn = document.getElementById('debugDataBtn');

            if (debugBtn) {
                debugBtn.addEventListener('click', debugSequences);
            }

            if (debugDataBtn) {
                debugDataBtn.addEventListener('click', debugParsedData);
            }
        });

        // Final Test Chart Manager Class
        class FinalTestChartManager {
            constructor() {
                this.charts = {};
                this.colors = {
                    primary: '#10b981',
                    secondary: '#059669', 
                    accent: '#34d399',
                    warning: '#f59e0b',
                    danger: '#ef4444',
                    info: '#3b82f6'
                };
            }

            createAllCharts() {
                this.createYieldComparisonChart();
                this.createDataCorrelationChart();
                this.createStageComparisonChart();
                this.createYieldCorrelationChart();
                this.createCorrelationMatrixChart();
                this.createTrendAnalysisChart();
                this.createBinDistributionChart();
                this.createBinTrendChart();
                this.createRiskTrendChart();
                this.createRiskDistributionChart();
            }

            createYieldComparisonChart() {
                const ctx = document.getElementById('yield-comparison-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Initial Test', 'Retest 1', 'Retest 2', 'Final Test'],
                    datasets: [{
                        label: 'Yield %',
                        data: [85.2, 91.5, 94.8, 96.2],
                        borderColor: this.colors.primary,
                        backgroundColor: this.colors.primary + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                };

                this.charts.yieldComparison = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: { display: true, text: 'Yield (%)' }
                            }
                        }
                    }
                });
            }

            createDataCorrelationChart() {
                const ctx = document.getElementById('data-correlation-chart');
                if (!ctx) return;

                const data = {
                    datasets: [{
                        label: 'Lot Data Points',
                        data: [
                            {x: 85, y: 91}, {x: 87, y: 93}, {x: 82, y: 88},
                            {x: 90, y: 95}, {x: 88, y: 92}, {x: 86, y: 90}
                        ],
                        backgroundColor: this.colors.primary,
                        borderColor: this.colors.secondary,
                        borderWidth: 2,
                        pointRadius: 6
                    }]
                };

                this.charts.dataCorrelation = new Chart(ctx, {
                    type: 'scatter',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Initial Yield (%)' } },
                            y: { title: { display: true, text: 'Final Yield (%)' } }
                        }
                    }
                });
            }

            createStageComparisonChart() {
                const ctx = document.getElementById('stage-comparison-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Stage 1', 'Stage 2', 'Stage 3', 'Stage 4'],
                    datasets: [{
                        label: 'Pass Count',
                        data: [850, 915, 948, 962],
                        backgroundColor: this.colors.primary,
                        borderColor: this.colors.secondary,
                        borderWidth: 1
                    }, {
                        label: 'Fail Count',
                        data: [150, 85, 52, 38],
                        backgroundColor: this.colors.danger,
                        borderColor: '#dc2626',
                        borderWidth: 1
                    }]
                };

                this.charts.stageComparison = new Chart(ctx, {
                    type: 'bar',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, title: { display: true, text: 'Count' } }
                        }
                    }
                });
            }

            createYieldCorrelationChart() {
                const ctx = document.getElementById('yield-correlation-chart');
                if (!ctx) return;

                const data = {
                    datasets: [{
                        label: 'Yield Correlation',
                        data: [
                            {x: 85, y: 87}, {x: 90, y: 92}, {x: 82, y: 85},
                            {x: 95, y: 96}, {x: 88, y: 91}, {x: 86, y: 89}
                        ],
                        backgroundColor: this.colors.accent,
                        borderColor: this.colors.primary,
                        borderWidth: 2,
                        pointRadius: 5
                    }]
                };

                this.charts.yieldCorrelation = new Chart(ctx, {
                    type: 'scatter',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            x: { title: { display: true, text: 'Expected Yield (%)' } },
                            y: { title: { display: true, text: 'Actual Yield (%)' } }
                        }
                    }
                });
            }

            createCorrelationMatrixChart() {
                const ctx = document.getElementById('correlation-matrix-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Test 1', 'Test 2', 'Test 3', 'Test 4'],
                    datasets: [{
                        label: 'Correlation Values',
                        data: [0.95, 0.87, 0.78, 0.92],
                        backgroundColor: [
                            this.colors.primary,
                            this.colors.secondary,
                            this.colors.accent,
                            this.colors.info
                        ],
                        borderWidth: 1
                    }]
                };

                this.charts.correlationMatrix = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        }
                    }
                });
            }

            createTrendAnalysisChart() {
                const ctx = document.getElementById('trend-analysis-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5'],
                    datasets: [{
                        label: 'Yield Trend',
                        data: [85, 87, 89, 91, 93],
                        borderColor: this.colors.primary,
                        backgroundColor: this.colors.primary + '20',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                };

                this.charts.trendAnalysis = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: { display: true, text: 'Yield (%)' }
                            }
                        }
                    }
                });
            }

            createBinDistributionChart() {
                const ctx = document.getElementById('bin-distribution-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Pass', 'Fail DC', 'Fail AC', 'Fail Func', 'Marginal'],
                    datasets: [{
                        data: [850, 75, 45, 30, 25],
                        backgroundColor: [
                            this.colors.primary,
                            this.colors.danger,
                            this.colors.warning,
                            '#8b5cf6',
                            '#f59e0b'
                        ],
                        borderWidth: 2
                    }]
                };

                this.charts.binDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        }
                    }
                });
            }

            createBinTrendChart() {
                const ctx = document.getElementById('bin-trend-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
                    datasets: [{
                        label: 'Pass',
                        data: [840, 850, 860, 845, 855],
                        borderColor: this.colors.primary,
                        backgroundColor: this.colors.primary + '20',
                        borderWidth: 2,
                        fill: false
                    }, {
                        label: 'Fail',
                        data: [75, 70, 65, 80, 70],
                        borderColor: this.colors.danger,
                        backgroundColor: this.colors.danger + '20',
                        borderWidth: 2,
                        fill: false
                    }]
                };

                this.charts.binTrend = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: { title: { display: true, text: 'Count' } }
                        }
                    }
                });
            }

            createRiskTrendChart() {
                const ctx = document.getElementById('risk-trend-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5'],
                    datasets: [{
                        label: 'Risk Score',
                        data: [25, 20, 15, 18, 12],
                        borderColor: this.colors.danger,
                        backgroundColor: this.colors.danger + '20',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                };

                this.charts.riskTrend = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Risk Score' }
                            }
                        }
                    }
                });
            }

            createRiskDistributionChart() {
                const ctx = document.getElementById('risk-distribution-chart');
                if (!ctx) return;

                const data = {
                    labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
                    datasets: [{
                        data: [60, 25, 10, 5],
                        backgroundColor: [
                            this.colors.primary,
                            this.colors.warning,
                            '#f97316',
                            this.colors.danger
                        ],
                        borderWidth: 2
                    }]
                };

                this.charts.riskDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: false }
                        }
                    }
                });
            }

            updateSummaryStats() {
                // Sample data update - integrate with real data
                document.getElementById('summary-total-files').textContent = '12';
                document.getElementById('summary-final-yield').textContent = '94.2%';
                document.getElementById('summary-total-lots').textContent = '8';
                document.getElementById('summary-tested-units').textContent = '1,248';
            }

            destroy() {
                Object.values(this.charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                this.charts = {};
            }
        }

        // PDF Report Generation for Final Test
        async function generateFinalTestPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Show loading overlay
            const loadingOverlay = document.createElement('div');
            loadingOverlay.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
                        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin: 15px 0 0 0; font-family: Arial, sans-serif;">Generating Final Test Report...</p>
                    </div>
                </div>
            `;
            document.body.appendChild(loadingOverlay);

            try {
                // Add title page
                pdf.setFontSize(20);
                pdf.setFont(undefined, 'bold');
                pdf.text('Final Test Analytics Report', 20, 30);
                
                pdf.setFontSize(12);
                pdf.setFont(undefined, 'normal');
                pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
                pdf.text('Semiconductor Value Chain ERP v5.0', 20, 55);

                // Add summary statistics
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Summary Statistics', 20, 80);
                
                pdf.setFontSize(11);
                pdf.setFont(undefined, 'normal');
                
                const summaryStats = [
                    ['Total Files Processed', document.getElementById('summary-total-files').textContent],
                    ['Final Test Yield', document.getElementById('summary-final-yield').textContent],
                    ['Total Lots Analyzed', document.getElementById('summary-total-lots').textContent],
                    ['Tested Units', document.getElementById('summary-tested-units').textContent]
                ];
                
                let yPos = 95;
                summaryStats.forEach(([label, value]) => {
                    pdf.text(`${label}: ${value}`, 25, yPos);
                    yPos += 8;
                });

                // Add charts section
                pdf.setFontSize(16);
                pdf.setFont(undefined, 'bold');
                pdf.text('Chart Analysis', 20, 140);

                let currentY = 155;
                let pageHeight = pdf.internal.pageSize.height;
                let pageWidth = pdf.internal.pageSize.width;

                const chartIds = [
                    'yield-comparison-chart',
                    'data-correlation-chart', 
                    'stage-comparison-chart',
                    'yield-correlation-chart'
                ];

                for (let i = 0; i < chartIds.length; i++) {
                    const chartElement = document.getElementById(chartIds[i]);
                    if (chartElement && currentY < pageHeight - 60) {
                        try {
                            const canvas = await html2canvas(chartElement.closest('.bg-white'), {
                                scale: 2,
                                logging: false,
                                useCORS: true
                            });
                            
                            const imgData = canvas.toDataURL('image/png');
                            const imgWidth = pageWidth - 40;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            if (currentY + imgHeight > pageHeight - 20) {
                                pdf.addPage();
                                currentY = 20;
                            }
                            
                            pdf.addImage(imgData, 'PNG', 20, currentY, imgWidth, imgHeight);
                            currentY += imgHeight + 15;
                        } catch (chartError) {
                            console.warn(`Could not capture chart ${chartIds[i]}:`, chartError);
                        }
                    }
                }

                // Add footer to all pages
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setFont(undefined, 'normal');
                    pdf.text(`Final Test Analytics Report - Page ${i} of ${totalPages}`, pageWidth - 80, pageHeight - 10);
                }

                // Save PDF
                pdf.save('final-test-analytics-report.pdf');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF report. Exporting summary data instead.');
                
                // Fallback to JSON export
                const summaryData = {
                    reportType: 'Final Test Analytics',
                    generatedDate: new Date().toISOString(),
                    summary: {
                        totalFiles: document.getElementById('summary-total-files').textContent,
                        finalYield: document.getElementById('summary-final-yield').textContent,
                        totalLots: document.getElementById('summary-total-lots').textContent,
                        testedUnits: document.getElementById('summary-tested-units').textContent
                    }
                };
                
                const blob = new Blob([JSON.stringify(summaryData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'final-test-summary.json';
                a.click();
                URL.revokeObjectURL(url);
            } finally {
                // Hide loading overlay
                document.body.removeChild(loadingOverlay);
            }
        }

        // Initialize Final Test Chart Manager
        let finalTestChartManager = null;

        // Update generateReport function
        function generateReport() {
            generateFinalTestPDF();
        }

        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize chart manager
            finalTestChartManager = new FinalTestChartManager();
            
            // Create charts after a short delay to ensure DOM is ready
            setTimeout(() => {
                finalTestChartManager.createAllCharts();
                finalTestChartManager.updateSummaryStats();
            }, 500);
        });

        // Global functions
        function goBack() {
            window.location.href = 'wafer map dashboard v5.0-integrated.html';
        }

    </script>
</body>
</html>f u n c t i o n   g o B a c k ( )   {   w i n d o w . l o c a t i o n . h r e f   =   ' w a f e r   m a p   d a s h b o a r d   v 5 . 0 - i n t e g r a t e d . h t m l ' ;   } 
 
 