<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Packaging Analytics - Semiconductor Value Chain ERP</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📦</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Ensure CSS works - Critical styles inline */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f1f5f9; 
        }
        
        .main-tab.active { 
            border-color: #ea580c !important; 
            color: #ea580c !important; 
            background-color: #fff7ed !important; 
        }
        
        .main-tab { 
            border-color: transparent; 
            transition: all 0.2s ease;
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content:not(.hidden) { 
            display: block; 
        }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #ea580c; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* File upload area hover effects */
        .upload-area:hover {
            border-color: #ea580c;
            background-color: #fff7ed;
        }
        
        /* Progress bar animations */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Chart container */
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 250px; 
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="dashboard-page" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white px-6 py-3 border-b flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">📦 Packaging Analytics</h1>
                    <p class="text-sm text-gray-600">Packaging run lot data analysis and wafer-to-IC mapping management</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">Semiconductor Value Chain ERP v5.0</span>
                <button onclick="generateReport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Generate Report
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="main-tabs" class="flex border-b bg-slate-50">
            <button data-tab="summary" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300 active">Summary</button>
            <button data-tab="file-upload" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">File Upload</button>
            <button data-tab="run-lot-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Run Lot Analysis</button>
            <button data-tab="yield-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Yield Analysis</button>
            <button data-tab="wafer-mapping" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Wafer Mapping</button>
            <button data-tab="quality-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Quality Analysis</button>
        </nav>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Summary Tab -->
            <div id="summary-tab" class="tab-content">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📦 Packaging Analytics</h1>
                    <p class="text-sm text-gray-600">Packaging run lot data analysis and wafer-to-IC mapping management</p>
                </div>

                <!-- Quick Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Files</p>
                                <p id="summary-total-files" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Overall Yield</p>
                                <p id="summary-overall-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Run Lots</p>
                                <p id="summary-total-lots" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Mapped ICs</p>
                                <p id="summary-mapped-ics" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div class="bg-gradient-to-r from-orange-50 to-amber-50 p-6 rounded-lg border border-orange-200">
                    <h2 class="text-xl font-semibold text-orange-800 mb-3">📦 Packaging Analytics Dashboard</h2>
                    <p class="text-orange-700 mb-4">
                        This dashboard provides comprehensive analysis tools for packaging run lot data and wafer-to-IC mapping. 
                        Upload your Excel packaging reports to get started with detailed analytics.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📁 Excel Files</h3>
                            <p class="text-gray-600">Upload .xlsx/.xls packaging reports</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📊 Analysis</h3>
                            <p class="text-gray-600">Run lot yield and wafer mapping analysis</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">📈 Reports</h3>
                            <p class="text-gray-600">Export comprehensive packaging reports</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Analysis Results -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Recent Analysis Results</h3>
                    </div>
                    <div class="p-6">
                        <div id="recent-results" class="text-center text-gray-500">
                            <p>Upload Excel packaging files to see analysis results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="file-upload-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📁 Excel File Upload</h1>
                    <p class="text-gray-600">Upload packaging Excel files for comprehensive analysis</p>
                </div>

                <!-- File Upload Area -->
                <div class="bg-white p-8 rounded-lg shadow border border-dashed border-gray-300">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="mt-4">
                            <label for="excel-file-upload" class="cursor-pointer">
                                <span class="mt-2 block text-sm font-medium text-gray-900">Upload Excel Files</span>
                                <span class="mt-1 block text-sm text-gray-500">Drag and drop or click to select .xlsx or .xls files</span>
                            </label>
                            <input id="excel-file-upload" type="file" multiple accept=".xlsx,.xls" class="sr-only" />
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="mt-6 hidden">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📤 Upload Progress</h3>
                        <div id="progress-container" class="space-y-4">
                            <!-- Progress items will be added here -->
                        </div>
                    </div>
                </div>

                <!-- File List -->
                <div id="file-list" class="mt-6 hidden">
                    <div class="bg-white rounded-lg shadow border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-800">📋 Uploaded Files</h3>
                        </div>
                        <div class="p-6">
                            <div id="uploaded-files" class="space-y-4">
                                <!-- File items will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div id="analysis-controls" class="mt-6 hidden">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🔧 Analysis Controls</h3>
                        <div class="flex flex-wrap gap-4">
                            <button id="analyze-all-files" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-play mr-2"></i>Analyze All Files
                            </button>
                            <button id="clear-all-files" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-trash mr-2"></i>Clear All Files
                            </button>
                            <button id="export-analysis" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-download mr-2"></i>Export Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Run Lot Analysis Tab -->
            <div id="run-lot-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📦 Run Lot Analysis Dashboard</h1>
                    <p class="text-gray-600">Advanced run lot analysis and yield optimization insights</p>
                </div>

                <!-- Run Lot Analysis Controls -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Run Lot Category</label>
                            <select id="run-lot-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Runs</option>
                                <option value="pass">Pass Runs</option>
                                <option value="fail">Fail Runs</option>
                                <option value="marginal">Marginal Runs</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Period</label>
                            <select id="run-lot-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="run-lot-sort-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="count">Count</option>
                                <option value="percentage">Percentage</option>
                                <option value="trend">Trend</option>
                            </select>
                        </div>
                        <button id="refresh-run-lot-analysis" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Run Lot Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Runs</p>
                                <p id="total-runs" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Pass Rate</p>
                                <p id="pass-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Fail Rate</p>
                                <p id="fail-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Marginal Rate</p>
                                <p id="marginal-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Run Lot Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Run Lot Distribution Chart -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 Run Lot Distribution</h3>
                        <div class="h-64">
                            <canvas id="run-lot-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Run Lot Trend Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Run Lot Trend Analysis</h3>
                        <div class="h-64">
                            <canvas id="run-lot-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Run Lot Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Run Lot Details</h3>
                    </div>
                    <div class="">
                        <table id="run-lot-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Run Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="run-lot-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Run lot rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Run Lot Optimization Insights -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">💡 Run Lot Optimization Insights</h3>
                    </div>
                    <div id="run-lot-insights" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Yield Improvement Opportunities -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">🎯 Yield Improvement Opportunities</h4>
                                <div id="yield-opportunities" class="space-y-2">
                                    <!-- Opportunities will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Run Consolidation Suggestions -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2">🔧 Run Consolidation Suggestions</h4>
                                <div id="consolidation-suggestions" class="space-y-2">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Yield Analysis Tab -->
            <div id="yield-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📦 Yield Analysis Dashboard</h1>
                    <p class="text-gray-600">Advanced yield analysis and optimization insights</p>
                </div>

                <!-- Yield Analysis Controls -->
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Yield Category</label>
                            <select id="yield-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Yields</option>
                                <option value="pass">Pass Yields</option>
                                <option value="fail">Fail Yields</option>
                                <option value="marginal">Marginal Yields</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Period</label>
                            <select id="yield-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="yield-sort-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="count">Count</option>
                                <option value="percentage">Percentage</option>
                                <option value="trend">Trend</option>
                            </select>
                        </div>
                        <button id="refresh-yield-analysis" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Yield Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Yields</p>
                                <p id="total-yields" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Average Yield</p>
                                <p id="average-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Low Yields</p>
                                <p id="low-yields" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">High Yields</p>
                                <p id="high-yields" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yield Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Yield Trend -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Yield Trend</h3>
                        <div class="h-64">
                            <canvas id="yield-trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Yield Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 Yield Distribution</h3>
                        <div class="h-64">
                            <canvas id="yield-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Yield Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Yield Details</h3>
                    </div>
                    <div class="">
                        <table id="yield-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lot Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Device</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Operator</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yield (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Good</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fail</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="yield-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Yield rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Yield Optimization Recommendations -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">💡 Yield Optimization Recommendations</h3>
                    </div>
                    <div id="yield-recommendations" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wafer Mapping Tab -->
            <div id="wafer-mapping-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">🗺️ Wafer Mapping Dashboard</h1>
                    <p class="text-gray-600">Visual wafer mapping and defect pattern recognition</p>
                </div>

                <!-- Wafer Mapping Controls -->
                <div class="mb-6 p-4 bg-indigo-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Map Type</label>
                            <select id="map-type-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="yield">Yield Map</option>
                                <option value="defect">Defect Map</option>
                                <option value="bin">Bin Map</option>
                                <option value="site">Site Map</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Wafer Size</label>
                            <select id="wafer-size-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="6">6 inch</option>
                                <option value="8">8 inch</option>
                                <option value="12" selected>12 inch</option>
                                <option value="18">18 inch</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color Scheme</label>
                            <select id="color-scheme-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="standard">Standard</option>
                                <option value="heat">Heat Map</option>
                                <option value="rainbow">Rainbow</option>
                                <option value="grayscale">Grayscale</option>
                            </select>
                        </div>
                        <button id="refresh-wafer-mapping" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Map
                        </button>
                    </div>
                </div>

                <!-- Wafer Map Display -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Main Wafer Map -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📊 Wafer Map Visualization</h3>
                        <div id="wafer-map-container" class="h-96 flex items-center justify-center text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                                </svg>
                                <p class="text-lg font-medium">Upload files to view wafer map</p>
                                <p class="text-sm text-gray-400">Select files in the Final Test tab to generate wafer map visualization</p>
                            </div>
                        </div>
                    </div>

                    <!-- Map Statistics -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Map Statistics</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Sites</span>
                                <span id="map-total-sites" class="font-semibold">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Pass Sites</span>
                                <span id="map-pass-sites" class="font-semibold text-green-600">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Fail Sites</span>
                                <span id="map-fail-sites" class="font-semibold text-red-600">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Yield %</span>
                                <span id="map-yield-percent" class="font-semibold text-blue-600">--</span>
                            </div>
                            <hr class="my-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Defect Density</span>
                                <span id="map-defect-density" class="font-semibold">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Cluster Score</span>
                                <span id="map-cluster-score" class="font-semibold">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Defect Pattern Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Defect Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 Defect Distribution</h3>
                        <div class="chart-container">
                            <canvas id="defect-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Spatial Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🗺️ Spatial Analysis</h3>
                        <div class="chart-container">
                            <canvas id="spatial-analysis-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Defect Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">📋 Defect Details</h3>
                    </div>
                    <div class="">
                        <table id="defect-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Run Lot</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wafer ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Position</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Defect Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="defect-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Defect rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Defect Analysis Insights -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">💡 Defect Analysis Insights</h3>
                    </div>
                    <div id="defect-insights" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Critical Defects -->
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-2">🚨 Critical Defects</h4>
                                <div id="critical-defects" class="space-y-2">
                                    <!-- Critical defects will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Improvement Opportunities -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">🎯 Improvement Opportunities</h4>
                                <div id="improvement-opportunities" class="space-y-2">
                                    <!-- Opportunities will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Metrics Tab -->
            <div id="quality-metrics-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">📊 Quality Metrics Dashboard</h1>
                    <p class="text-gray-600">Comprehensive quality metrics analysis and control monitoring</p>
                </div>

                <!-- Quality Metrics Controls -->
                <div class="mb-6 p-4 bg-orange-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Metric Type</label>
                            <select id="metric-type-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Metrics</option>
                                <option value="yield">Yield Metrics</option>
                                <option value="defect">Defect Metrics</option>
                                <option value="process">Process Metrics</option>
                                <option value="quality">Quality Metrics</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                            <select id="metric-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="1d">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                            </select>
                        </div>
                        <button id="refresh-quality-metrics" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded text-sm">
                            🔄 Refresh Metrics
                        </button>
                    </div>
                </div>

                <!-- Quality Metrics Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Quality Score</p>
                                <p id="quality-score" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Process Capability</p>
                                <p id="process-capability" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Out of Control</p>
                                <p id="out-of-control-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Critical Issues</p>
                                <p id="critical-issues-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quality Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Quality Trend -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">📈 Quality Trend</h3>
                        <div class="chart-container">
                            <canvas id="quality-trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Defect Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">🎯 Defect Distribution</h3>
                        <div class="chart-container">
                            <canvas id="quality-defect-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script>
        // Global variables
        let uploadedFiles = [];
        let parsedData = [];
        let analysisResults = {};
        let excelParser = null;

        // Excel Parser Class for Packaging Data
        class ExcelParser {
            constructor() {
                this.workbook = null;
            }

            async parseExcelFile(file) {
                try {
                    console.log('Parsing Excel file:', file.name);
                    
                    const arrayBuffer = await file.arrayBuffer();
                    this.workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    
                    return this.extractPackagingData(file.name);
                } catch (error) {
                    console.error('Error parsing Excel file:', error);
                    throw new Error(`Failed to parse Excel file: ${error.message}`);
                }
            }

            extractPackagingData(fileName) {
                const result = {
                    fileName: fileName,
                    fileType: 'packaging',
                    lotInfo: {
                        runLot: this.extractRunLot(fileName),
                        waferLot: this.extractWaferLot(fileName),
                        packagingDate: new Date().toISOString(),
                        packagingHouse: 'Company C'
                    },
                    summary: {
                        totalWafers: 0,
                        totalICs: 0,
                        packagingYield: 0,
                        totalGood: 0,
                        totalReject: 0
                    },
                    runLotData: this.generateSampleRunLotData(),
                    waferMapping: this.generateSampleWaferMapping(),
                    qualityData: this.generateSampleQualityData()
                };

                this.calculateSummaryStats(result);
                return result;
            }

            extractRunLot(fileName) {
                const match = fileName.match(/([R][0-9]+)/i);
                return match ? match[1] : `R${Math.floor(Math.random() * 10000)}`;
            }

            extractWaferLot(fileName) {
                const match = fileName.match(/([S][0-9A-Z]+)/i);
                return match ? match[1] : `S95WR-${Math.floor(Math.random() * 1000)}`;
            }

            generateSampleRunLotData() {
                const runLots = [];
                for (let i = 1; i <= 10; i++) {
                    const input = Math.floor(Math.random() * 100) + 50;
                    const output = Math.floor(input * (Math.random() * 0.3 + 0.7));
                    runLots.push({
                        runLot: `R${1000 + i}`,
                        waferLot: `S95WR-${100 + i}`,
                        input: input,
                        output: output,
                        yield: (output / input * 100).toFixed(2),
                        packagingDate: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
                    });
                }
                return runLots;
            }

            generateSampleWaferMapping() {
                const mapping = [];
                const icTypes = ['MLC3740S', 'MLC3740STV', 'MLC3741S', 'MLC3742S'];
                for (let i = 1; i <= 25; i++) {
                    mapping.push({
                        waferLot: `S95WR-${100 + Math.floor(i / 5)}`,
                        waferId: `W${i}`,
                        icPartNumber: icTypes[Math.floor(Math.random() * icTypes.length)],
                        quantity: Math.floor(Math.random() * 50) + 20,
                        position: `${String.fromCharCode(65 + Math.floor(i / 5))}${i % 5 + 1}`
                    });
                }
                return mapping;
            }

            generateSampleQualityData() {
                const quality = [];
                const testTypes = ['Visual Inspection', 'Wire Bond Check', 'Package Integrity', 'Marking Quality'];
                const defectTypes = ['None', 'Wire Bond', 'Package Crack', 'Marking Error', 'Contamination'];
                
                for (let i = 1; i <= 20; i++) {
                    quality.push({
                        runLot: `R${1000 + Math.floor(i / 2)}`,
                        testType: testTypes[Math.floor(Math.random() * testTypes.length)],
                        result: Math.random() > 0.15 ? 'Pass' : 'Fail',
                        defectType: Math.random() > 0.85 ? defectTypes[Math.floor(Math.random() * defectTypes.length)] : 'None',
                        inspector: `QC${Math.floor(Math.random() * 5) + 1}`
                    });
                }
                return quality;
            }

            calculateSummaryStats(result) {
                result.summary.totalWafers = result.waferMapping.length;
                result.summary.totalICs = result.waferMapping.reduce((sum, item) => sum + (item.quantity || 0), 0);
                
                if (result.runLotData.length > 0) {
                    const totalInput = result.runLotData.reduce((sum, item) => sum + (item.input || 0), 0);
                    const totalOutput = result.runLotData.reduce((sum, item) => sum + (item.output || 0), 0);
                    result.summary.packagingYield = totalInput > 0 ? (totalOutput / totalInput * 100).toFixed(2) : 0;
                    result.summary.totalGood = totalOutput;
                    result.summary.totalReject = totalInput - totalOutput;
                }
            }
        }

        // File Upload Handler Class
        class FileUploadHandler {
            constructor() {
                this.uploadArea = null;
                this.fileInput = null;
            }

            init() {
                this.setupDragAndDrop();
                this.setupFileInput();
            }

            setupDragAndDrop() {
                const uploadArea = document.querySelector('#file-upload-tab .bg-white.p-8');
                if (!uploadArea) return;

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('border-blue-500', 'bg-blue-50');
                });

                uploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('border-blue-500', 'bg-blue-50');
                    
                    const files = Array.from(e.dataTransfer.files).filter(file => 
                        file.name.endsWith('.xlsx') || file.name.endsWith('.xls')
                    );
                    
                    if (files.length > 0) {
                        this.handleFiles(files);
                    }
                });
            }

            setupFileInput() {
                const fileInput = document.getElementById('excel-file-upload');
                if (!fileInput) return;

                fileInput.addEventListener('change', (e) => {
                    const files = Array.from(e.target.files);
                    if (files.length > 0) {
                        this.handleFiles(files);
                    }
                });
            }

            async handleFiles(files) {
                console.log('Processing', files.length, 'files');
                
                const progressContainer = document.getElementById('progress-container');
                const uploadProgress = document.getElementById('upload-progress');
                const fileList = document.getElementById('file-list');
                const uploadedFiles = document.getElementById('uploaded-files');
                const analysisControls = document.getElementById('analysis-controls');
                
                uploadProgress.classList.remove('hidden');
                progressContainer.innerHTML = '';
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    await this.processFile(file, progressContainer);
                }

                // Show file list and controls
                fileList.classList.remove('hidden');
                analysisControls.classList.remove('hidden');
                this.updateFileList();
                this.updateSummaryStats();
            }

            async processFile(file, container) {
                const progressItem = document.createElement('div');
                progressItem.className = 'border rounded-lg p-4';
                progressItem.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium">${file.name}</span>
                        <span class="text-sm text-blue-600">Processing...</span>
                    </div>
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                `;
                container.appendChild(progressItem);

                const progressBar = progressItem.querySelector('.bg-blue-600');
                const statusText = progressItem.querySelector('.text-blue-600');

                try {
                    progressBar.style.width = '30%';
                    statusText.textContent = 'Reading file...';

                    const data = await excelParser.parseExcelFile(file);
                    
                    progressBar.style.width = '70%';
                    statusText.textContent = 'Analyzing data...';

                    uploadedFiles.push({
                        file: file,
                        data: data,
                        uploadTime: new Date().toISOString()
                    });
                    parsedData.push(data);

                    progressBar.style.width = '100%';
                    statusText.textContent = 'Complete';
                    statusText.className = 'text-sm text-green-600';

                } catch (error) {
                    console.error('Error processing file:', error);
                    progressBar.style.width = '100%';
                    progressBar.className = 'bg-red-600 h-2 rounded-full';
                    statusText.textContent = 'Error: ' + error.message;
                    statusText.className = 'text-sm text-red-600';
                }
            }

            updateFileList() {
                const container = document.getElementById('uploaded-files');
                container.innerHTML = '';

                uploadedFiles.forEach((fileData, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'border rounded-lg p-4 flex items-center justify-between';
                    fileItem.innerHTML = `
                        <div>
                            <h4 class="font-medium">${fileData.file.name}</h4>
                            <p class="text-sm text-gray-600">Run Lot: ${fileData.data.lotInfo.runLot} | Wafer Lot: ${fileData.data.lotInfo.waferLot}</p>
                            <p class="text-sm text-gray-500">Uploaded: ${new Date(fileData.uploadTime).toLocaleString()}</p>
                        </div>
                        <button onclick="removeFile(${index})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(fileItem);
                });
            }

            updateSummaryStats() {
                let totalFiles = parsedData.length;
                let totalLots = 0;
                let totalMappedICs = 0;
                let weightedYield = 0;
                let totalInput = 0;

                parsedData.forEach(data => {
                    totalLots += data.runLotData.length;
                    totalMappedICs += data.summary.totalICs;
                    totalInput += data.runLotData.reduce((sum, lot) => sum + lot.input, 0);
                    weightedYield += data.runLotData.reduce((sum, lot) => sum + (lot.input * lot.yield), 0);
                });

                const overallYield = totalInput > 0 ? (weightedYield / totalInput).toFixed(2) + '%' : '--';

                document.getElementById('summary-total-files').textContent = totalFiles;
                document.getElementById('summary-overall-yield').textContent = overallYield;
                document.getElementById('summary-total-lots').textContent = totalLots;
                document.getElementById('summary-mapped-ics').textContent = totalMappedICs;

                // Update recent results
                const recentResults = document.getElementById('recent-results');
                if (totalFiles > 0) {
                    recentResults.innerHTML = `
                        <div class="text-left">
                            <p class="text-lg font-semibold text-gray-800 mb-2">Latest Analysis Results</p>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div class="bg-blue-50 p-3 rounded">
                                    <span class="font-medium">Files Processed:</span> ${totalFiles}
                                </div>
                                <div class="bg-green-50 p-3 rounded">
                                    <span class="font-medium">Overall Yield:</span> ${overallYield}
                                </div>
                                <div class="bg-purple-50 p-3 rounded">
                                    <span class="font-medium">Run Lots:</span> ${totalLots}
                                </div>
                                <div class="bg-orange-50 p-3 rounded">
                                    <span class="font-medium">Mapped ICs:</span> ${totalMappedICs}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Update charts with new data
                if (packagingChartManager && totalFiles > 0) {
                    setTimeout(() => {
                        packagingChartManager.updateChartsWithData();
                    }, 500); // Small delay to ensure DOM is ready
                }
            }
        }

        // Utility Functions
        function goBack() {
            window.history.back();
        }

        function generateReport() {
            generatePDFReport();
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            parsedData.splice(index, 1);
            
            const fileUploadHandler = new FileUploadHandler();
            fileUploadHandler.updateFileList();
            fileUploadHandler.updateSummaryStats();
        }

        // Tab switching function
        function initializeTabSwitching() {
            const tabButtons = document.querySelectorAll('.main-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active', 'border-blue-500', 'text-blue-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // File upload initialization
        function initializeFileUpload() {
            const fileUploadHandler = new FileUploadHandler();
            fileUploadHandler.init();

            // Analysis controls
            const analyzeAllBtn = document.getElementById('analyze-all-files');
            const clearAllBtn = document.getElementById('clear-all-files');
            const exportBtn = document.getElementById('export-analysis');

            if (analyzeAllBtn) {
                analyzeAllBtn.addEventListener('click', function() {
                    console.log('Starting comprehensive analysis of all uploaded files...');
                    // Implementation for analyze all files
                });
            }

            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', function() {
                    uploadedFiles = [];
                    parsedData = [];
                    analysisResults = {};
                    
                    // Clear UI
                    document.getElementById('upload-progress').classList.add('hidden');
                    document.getElementById('file-list').classList.add('hidden');
                    document.getElementById('analysis-controls').classList.add('hidden');
                    
                    // Reset summary stats
                    document.getElementById('summary-total-files').textContent = '0';
                    document.getElementById('summary-overall-yield').textContent = '--';
                    document.getElementById('summary-total-lots').textContent = '0';
                    document.getElementById('summary-mapped-ics').textContent = '0';
                    
                    // Reset recent results
                    document.getElementById('recent-results').innerHTML = '<p>Upload Excel packaging files to see analysis results</p>';
                    
                    console.log('All files cleared');
                });
            }

            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportAnalysisResults();
                });
            }
        }

        // Export analysis results to Excel
        function exportAnalysisResults() {
            if (parsedData.length === 0) {
                alert('No data to export. Please upload files first.');
                return;
            }

            console.log('Exporting analysis results to Excel...');
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            
            // Summary sheet
            const summaryData = [
                ['Packaging Analysis Summary Report'],
                ['Generated:', new Date().toLocaleString()],
                [''],
                ['Summary Statistics'],
                ['Total Files', parsedData.length],
                ['Total Run Lots', parsedData.reduce((sum, data) => sum + data.runLotData.length, 0)],
                ['Total Mapped ICs', parsedData.reduce((sum, data) => sum + data.summary.totalICs, 0)],
                [''],
                ['Run Lot Details'],
                ['Run Lot', 'Wafer Lot', 'Input', 'Output', 'Yield (%)', 'Packaging Date']
            ];
            
            parsedData.forEach(data => {
                data.runLotData.forEach(lot => {
                    summaryData.push([
                        lot.runLot,
                        lot.waferLot,
                        lot.input,
                        lot.output,
                        lot.yield,
                        lot.packagingDate
                    ]);
                });
            });
            
            const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, summaryWs, 'Summary');
            
            // Wafer Mapping sheet
            const mappingData = [
                ['Wafer to IC Mapping'],
                ['Wafer Lot', 'Wafer ID', 'IC Part Number', 'Quantity', 'Position']
            ];
            
            parsedData.forEach(data => {
                data.waferMapping.forEach(mapping => {
                    mappingData.push([
                        mapping.waferLot,
                        mapping.waferId,
                        mapping.icPartNumber,
                        mapping.quantity,
                        mapping.position
                    ]);
                });
            });
            
            const mappingWs = XLSX.utils.aoa_to_sheet(mappingData);
            XLSX.utils.book_append_sheet(wb, mappingWs, 'Wafer Mapping');
            
            // Quality Data sheet
            const qualityData = [
                ['Quality Control Data'],
                ['Run Lot', 'Test Type', 'Result', 'Defect Type', 'Inspector']
            ];
            
            parsedData.forEach(data => {
                data.qualityData.forEach(quality => {
                    qualityData.push([
                        quality.runLot,
                        quality.testType,
                        quality.result,
                        quality.defectType,
                        quality.inspector
                    ]);
                });
            });
            
            const qualityWs = XLSX.utils.aoa_to_sheet(qualityData);
            XLSX.utils.book_append_sheet(wb, qualityWs, 'Quality Data');
            
            // Export file
            const fileName = `packaging-analysis-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            console.log('Analysis results exported successfully');
        }

        // Chart Management Class for Packaging Analytics
        class PackagingChartManager {
            constructor() {
                this.charts = {};
            }

            createRunLotDistributionChart(data) {
                const ctx = document.getElementById('run-lot-distribution-chart');
                if (!ctx || !data) return;

                if (this.charts.runLotDistribution) {
                    this.charts.runLotDistribution.destroy();
                }

                this.charts.runLotDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.map(d => d.runLot),
                        datasets: [{
                            data: data.map(d => d.input),
                            backgroundColor: [
                                '#f97316', '#ea580c', '#dc2626', '#b91c1c', '#991b1b',
                                '#fbbf24', '#f59e0b', '#d97706', '#b45309', '#92400e'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createRunLotTrendChart(data) {
                const ctx = document.getElementById('run-lot-trend-chart');
                if (!ctx || !data) return;

                if (this.charts.runLotTrend) {
                    this.charts.runLotTrend.destroy();
                }

                this.charts.runLotTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.packagingDate),
                        datasets: [{
                            label: 'Input Units',
                            data: data.map(d => d.input),
                            borderColor: '#ea580c',
                            backgroundColor: 'rgba(234, 88, 12, 0.1)',
                            tension: 0.4
                        }, {
                            label: 'Output Units',
                            data: data.map(d => d.output),
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Units'
                                }
                            }
                        }
                    }
                });
            }

            createYieldTrendChart(data) {
                const ctx = document.getElementById('yield-trend-chart');
                if (!ctx || !data) return;

                if (this.charts.yieldTrend) {
                    this.charts.yieldTrend.destroy();
                }

                this.charts.yieldTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.runLot),
                        datasets: [{
                            label: 'Yield (%)',
                            data: data.map(d => d.yield),
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.2)',
                            tension: 0.1,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Yield (%)'
                                }
                            }
                        }
                    }
                });
            }

            createYieldDistributionChart(data) {
                const ctx = document.getElementById('yield-distribution-chart');
                if (!ctx || !data) return;

                if (this.charts.yieldDistribution) {
                    this.charts.yieldDistribution.destroy();
                }

                // Calculate yield ranges
                const ranges = { high: 0, medium: 0, low: 0 };
                data.forEach(d => {
                    if (d.yield >= 95) ranges.high++;
                    else if (d.yield >= 85) ranges.medium++;
                    else ranges.low++;
                });

                this.charts.yieldDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['High Yield (≥95%)', 'Medium Yield (85-94%)', 'Low Yield (<85%)'],
                        datasets: [{
                            data: [ranges.high, ranges.medium, ranges.low],
                            backgroundColor: ['#16a34a', '#f59e0b', '#dc2626'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Count'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            updateChartsWithData() {
                if (parsedData.length === 0) return;

                // Aggregate all run lot data
                const allRunLots = [];
                parsedData.forEach(data => {
                    allRunLots.push(...data.runLotData);
                });

                this.createRunLotDistributionChart(allRunLots.slice(0, 10)); // Top 10 for visibility
                this.createRunLotTrendChart(allRunLots);
                this.createYieldTrendChart(allRunLots);
                this.createYieldDistributionChart(allRunLots);
            }
        }

        // Global chart manager
        let packagingChartManager = null;

        // PDF Report Generation for Packaging
        async function generatePDFReport() {
            if (parsedData.length === 0) {
                alert('No data available. Please upload packaging files first.');
                return;
            }

            try {
                // Show loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="margin-bottom: 15px;">Generating Packaging Report...</div>
                            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #ea580c; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                `;
                document.body.appendChild(loadingIndicator);

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPosition = 20;

                // Add title
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Packaging Analytics Report', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Add generation date
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                // Add summary statistics
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Summary Statistics', 20, yPosition);
                yPosition += 10;

                const totalRunLots = parsedData.reduce((sum, data) => sum + data.runLotData.length, 0);
                const totalICs = parsedData.reduce((sum, data) => sum + data.summary.totalICs, 0);
                const avgYield = parsedData.reduce((sum, data) => {
                    const dataAvg = data.runLotData.reduce((s, lot) => s + lot.yield, 0) / data.runLotData.length;
                    return sum + dataAvg;
                }, 0) / parsedData.length;

                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                const summaryText = [
                    `Total Files Analyzed: ${parsedData.length}`,
                    `Total Run Lots: ${totalRunLots}`,
                    `Total Mapped ICs: ${totalICs}`,
                    `Average Yield: ${avgYield.toFixed(2)}%`,
                    `Report Date: ${new Date().toLocaleDateString()}`
                ];

                summaryText.forEach(text => {
                    pdf.text(text, 25, yPosition);
                    yPosition += 7;
                });

                yPosition += 10;

                // Add run lot details
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Run Lot Analysis', 20, yPosition);
                yPosition += 10;

                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                
                parsedData.forEach((data, fileIndex) => {
                    if (yPosition > pageHeight - 40) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.text(`File ${fileIndex + 1}: ${data.fileName || 'Unknown'}`, 25, yPosition);
                    yPosition += 6;
                    
                    data.runLotData.slice(0, 10).forEach(lot => { // First 10 lots per file
                        if (yPosition > pageHeight - 20) {
                            pdf.addPage();
                            yPosition = 20;
                        }
                        
                        pdf.text(`  ${lot.runLot}: ${lot.input} → ${lot.output} (${lot.yield.toFixed(1)}%)`, 30, yPosition);
                        yPosition += 4;
                    });
                    yPosition += 3;
                });

                // Add footer
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
                    pdf.text('Generated by Semiconductor Value Chain ERP', 20, pageHeight - 10);
                }

                // Save the PDF
                const fileName = `packaging-analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Remove loading indicator
                document.body.removeChild(loadingIndicator);

                alert('PDF report generated successfully!');

            } catch (error) {
                console.error('Error generating PDF report:', error);
                alert('Error generating PDF report. Please try again.');
                
                const loadingIndicator = document.querySelector('div[style*="position: fixed"]');
                if (loadingIndicator) {
                    document.body.removeChild(loadingIndicator);
                }
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Initializing Packaging Analytics v5.0 ===');
            
            excelParser = new ExcelParser();
            console.log('✅ Excel Parser initialized successfully');

            // Initialize chart manager
            packagingChartManager = new PackagingChartManager();
            console.log('✅ Chart Manager initialized successfully');

            initializeTabSwitching();
            initializeFileUpload();
            
            console.log('✅ Application initialization complete');
        });


    </script>
</body>
</html>