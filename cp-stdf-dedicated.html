<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CP/EDS STDF Analytics - Semiconductor Value Chain ERP</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî¨</text></svg>">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.1.0/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/dashboard.css">
    <style>
        /* Ensure CSS works - Critical styles inline */
        body { 
            font-family: 'Noto Sans KR', sans-serif; 
            background-color: #f1f5f9; 
        }
        
        .main-tab.active { 
            border-color: #3b82f6 !important; 
            color: #3b82f6 !important; 
            background-color: #eff6ff !important; 
        }
        
        .main-tab { 
            border-color: transparent; 
            transition: all 0.2s ease;
        }
        
        .tab-content { 
            display: none; 
        }
        
        .tab-content:not(.hidden) { 
            display: block; 
        }
        
        .loader { 
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        
        /* File upload area hover effects */
        .upload-area:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        /* Progress bar animations */
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        /* Chart container */
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 250px; 
        }
        
        /* Ensure proper spacing and layout */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="dashboard-page" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white px-6 py-3 border-b flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="text-gray-600 hover:text-gray-800 transition-colors">
                    <i class="fas fa-arrow-left text-xl"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">üìä CP/EDS STDF Analytics</h1>
                    <p class="text-sm text-gray-600">Detailed CP/EDS test analysis and STDF data processing</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm text-gray-500">Semiconductor Value Chain ERP v5.0</span>
                <button onclick="generateReport()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>Generate Report
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <nav id="main-tabs" class="flex border-b bg-slate-50">
            <button data-tab="summary" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300 active">Summary</button>
            <button data-tab="file-upload" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">File Upload</button>
            <button data-tab="map-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">MAPÎ∂ÑÏÑù</button>
            <button data-tab="test-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Test Analysis</button>
            <button data-tab="binning-analysis" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">Binning Analysis</button>
            <button data-tab="risk-assessment" class="main-tab py-4 px-6 border-b-2 font-medium text-sm text-gray-500 hover:text-blue-600 hover:border-blue-300">RISKÌèâÍ∞Ä</button>
        </nav>

        <!-- Main Content -->
        <main class="p-6">
            <!-- Summary Tab -->
            <div id="summary-tab" class="tab-content">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üìä CP/EDS STDF Analytics</h1>
                    <p class="text-sm text-gray-600">Detailed CP/EDS test analysis and STDF data processing</p>
                </div>

                <!-- Quick Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Files</p>
                                <p id="summary-total-files" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Overall Yield</p>
                                <p id="summary-overall-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Lots</p>
                                <p id="summary-total-lots" class="text-2xl font-bold text-gray-900">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Last Updated</p>
                                <p id="summary-last-updated" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border border-blue-200">
                    <h2 class="text-xl font-semibold text-blue-800 mb-3">üöÄ CP/EDS STDF Analytics Dashboard</h2>
                    <p class="text-blue-700 mb-4">
                        This dashboard provides comprehensive analysis tools for CP/EDS STDF test data. 
                        Upload your STDF files to get started with detailed analytics and yield analysis.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">üìÅ STDF Files</h3>
                            <p class="text-gray-600">Upload .stdf and .stdf.gz files for analysis</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">üìä Analysis</h3>
                            <p class="text-gray-600">View detailed test and binning analysis</p>
                        </div>
                        <div class="bg-white p-3 rounded border">
                            <h3 class="font-semibold text-gray-800 mb-1">üìà Reports</h3>
                            <p class="text-gray-600">Export comprehensive reports and charts</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Analysis Results -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üìã Recent Analysis Results</h3>
                    </div>
                    <div class="p-6">
                        <div id="recent-results" class="text-center text-gray-500">
                            <p>Upload STDF files to see analysis results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Upload Tab -->
            <div id="file-upload-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üìÅ STDF File Upload</h1>
                    <p class="text-gray-600">Upload CP/EDS STDF files for comprehensive analysis</p>
                </div>

                <!-- File Upload Area -->
                <div class="bg-white p-8 rounded-lg shadow border border-dashed border-gray-300">
                    <div class="text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="mt-4">
                            <label for="stdf-file-upload" class="cursor-pointer">
                                <span class="mt-2 block text-sm font-medium text-gray-900">Upload STDF Files</span>
                                <span class="mt-1 block text-sm text-gray-500">Drag and drop or click to select .stdf or .stdf.gz files</span>
                            </label>
                            <input id="stdf-file-upload" type="file" multiple accept=".stdf,.stdf.gz" class="sr-only" />
                        </div>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div id="upload-progress" class="mt-6 hidden">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üì§ Upload Progress</h3>
                        <div id="progress-container" class="space-y-4">
                            <!-- Progress items will be added here -->
                        </div>
                    </div>
                </div>

                <!-- File List -->
                <div id="file-list" class="mt-6 hidden">
                    <div class="bg-white rounded-lg shadow border">
                        <div class="p-6 border-b">
                            <h3 class="text-lg font-semibold text-gray-800">üìã Uploaded Files</h3>
                        </div>
                        <div class="p-6">
                            <div id="uploaded-files" class="space-y-4">
                                <!-- File items will be added here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Controls -->
                <div id="analysis-controls" class="mt-6 hidden">
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üîß Analysis Controls</h3>
                        <div class="flex flex-wrap gap-4">
                            <button id="analyze-all-files" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-play mr-2"></i>Analyze All Files
                            </button>
                            <button id="clear-all-files" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-trash mr-2"></i>Clear All Files
                            </button>
                            <button id="export-analysis" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md transition-colors">
                                <i class="fas fa-download mr-2"></i>Export Analysis
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAP Analysis Tab -->
            <div id="map-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üó∫Ô∏è Wafer Map Analysis</h1>
                    <p class="text-gray-600">Visual wafer map analysis and defect pattern recognition</p>
                </div>

                <!-- Map Analysis Controls -->
                <div class="mb-6 p-4 bg-indigo-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Map Type</label>
                            <select id="map-type-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="yield">Yield Map</option>
                                <option value="defect">Defect Map</option>
                                <option value="bin">Bin Map</option>
                                <option value="site">Site Map</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Wafer Size</label>
                            <select id="wafer-size-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="6">6 inch</option>
                                <option value="8">8 inch</option>
                                <option value="12" selected>12 inch</option>
                                <option value="18">18 inch</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Color Scheme</label>
                            <select id="color-scheme-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="standard">Standard</option>
                                <option value="heat">Heat Map</option>
                                <option value="rainbow">Rainbow</option>
                                <option value="grayscale">Grayscale</option>
                            </select>
                        </div>
                        <button id="refresh-map-analysis" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded text-sm">
                            üîÑ Refresh Map
                        </button>
                    </div>
                </div>

                <!-- Wafer Map Display -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Main Wafer Map -->
                    <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Wafer Map Visualization</h3>
                        <div id="wafer-map-container" class="h-96 flex items-center justify-center text-gray-500 border-2 border-dashed border-gray-300 rounded-lg">
                            <div class="text-center">
                                <svg class="w-16 h-16 mx-auto mb-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m-6 3l6-3"></path>
                                </svg>
                                <p class="text-lg font-medium">Upload files to view wafer map</p>
                                <p class="text-sm text-gray-400">Select files in the Final Test tab to generate wafer map visualization</p>
                            </div>
                        </div>
                    </div>

                    <!-- Map Statistics -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Map Statistics</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Total Sites</span>
                                <span id="map-total-sites" class="font-semibold">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Pass Sites</span>
                                <span id="map-pass-sites" class="font-semibold text-green-600">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Fail Sites</span>
                                <span id="map-fail-sites" class="font-semibold text-red-600">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Yield %</span>
                                <span id="map-yield-percent" class="font-semibold text-blue-600">--</span>
                            </div>
                            <hr class="my-4">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Defect Density</span>
                                <span id="map-defect-density" class="font-semibold">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Cluster Score</span>
                                <span id="map-cluster-score" class="font-semibold">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Defect Pattern Analysis -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Defect Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Defect Distribution</h3>
                        <div class="chart-container">
                            <canvas id="defect-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Spatial Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üó∫Ô∏è Spatial Analysis</h3>
                        <div class="chart-container">
                            <canvas id="spatial-analysis-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Pattern Recognition Results -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üîç Pattern Recognition Results</h3>
                    </div>
                    <div class="p-6">
                        <div id="pattern-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Pattern results will be populated here -->
                            <div class="text-center text-gray-500">
                                <p>Upload files to analyze defect patterns</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Analysis Tab -->
            <div id="test-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üî¨ Test Analysis Dashboard</h1>
                    <p class="text-gray-600">Comprehensive test performance analysis and optimization insights</p>
                </div>

                <!-- Test Analysis Controls -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Test Type Filter</label>
                            <select id="test-type-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Tests</option>
                                <option value="dc">DC Tests</option>
                                <option value="ac">AC Tests</option>
                                <option value="functional">Functional Tests</option>
                                <option value="parametric">Parametric Tests</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time Range</label>
                            <select id="time-range-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Device Filter</label>
                            <select id="device-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Devices</option>
                            </select>
                        </div>
                        <button id="refresh-test-analysis" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                            üîÑ Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Test Performance Overview -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Overall Yield</p>
                                <p id="overall-yield" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Test Time</p>
                                <p id="avg-test-time" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Failure Rate</p>
                                <p id="failure-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Test Count</p>
                                <p id="total-tests" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Test Yield Trend -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Test Yield Trend</h3>
                        <div class="h-64">
                            <canvas id="test-yield-chart"></canvas>
                        </div>
                    </div>

                    <!-- Test Failure Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Test Failure Distribution</h3>
                        <div class="h-64">
                            <canvas id="test-failure-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Test Performance Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üìä Test Performance Details</h3>
                    </div>
                    <div class="">
                        <table id="test-performance-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Yield (%)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fail Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg Time (ms)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="test-performance-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Test rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Test Optimization Recommendations -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üí° Test Optimization Recommendations</h3>
                    </div>
                    <div id="test-recommendations" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Recommendations will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Binning Analysis Tab -->
            <div id="binning-analysis-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">üì¶ Binning Analysis Dashboard</h1>
                    <p class="text-gray-600">Advanced binning analysis and yield optimization insights</p>
                </div>

                <!-- Binning Analysis Controls -->
                <div class="mb-6 p-4 bg-green-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bin Category</label>
                            <select id="bin-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Bins</option>
                                <option value="pass">Pass Bins</option>
                                <option value="fail">Fail Bins</option>
                                <option value="marginal">Marginal Bins</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Analysis Period</label>
                            <select id="bin-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="bin-sort-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="count">Count</option>
                                <option value="percentage">Percentage</option>
                                <option value="trend">Trend</option>
                            </select>
                        </div>
                        <button id="refresh-binning-analysis" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm">
                            üîÑ Refresh Analysis
                        </button>
                    </div>
                </div>

                <!-- Binning Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Total Bins</p>
                                <p id="total-bins" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Pass Rate</p>
                                <p id="pass-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Fail Rate</p>
                                <p id="fail-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Marginal Rate</p>
                                <p id="marginal-rate" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Binning Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Bin Distribution Chart -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìä Bin Distribution</h3>
                        <div class="h-64">
                            <canvas id="bin-distribution-chart"></canvas>
                        </div>
                    </div>

                    <!-- Bin Trend Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Bin Trend Analysis</h3>
                        <div class="h-64">
                            <canvas id="bin-trend-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Binning Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üìã Binning Details</h3>
                    </div>
                    <div class="">
                        <table id="binning-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bin Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trend</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="binning-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Bin rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Binning Optimization Insights -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üí° Binning Optimization Insights</h3>
                    </div>
                    <div id="binning-insights" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Yield Improvement Opportunities -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">üéØ Yield Improvement Opportunities</h4>
                                <div id="yield-opportunities" class="space-y-2">
                                    <!-- Opportunities will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Bin Consolidation Suggestions -->
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2">üîß Bin Consolidation Suggestions</h4>
                                <div id="consolidation-suggestions" class="space-y-2">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RISK Assessment Tab -->
            <div id="risk-assessment-tab" class="tab-content hidden">
                <div class="mb-6">
                    <h1 class="text-2xl font-bold text-gray-800 mb-2">‚ö†Ô∏è Risk Assessment Dashboard</h1>
                    <p class="text-gray-600">Comprehensive risk analysis and quality control monitoring</p>
                </div>

                <!-- Risk Assessment Controls -->
                <div class="mb-6 p-4 bg-red-50 rounded-lg">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Risk Level</label>
                            <select id="risk-level-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Levels</option>
                                <option value="low">Low Risk</option>
                                <option value="medium">Medium Risk</option>
                                <option value="high">High Risk</option>
                                <option value="critical">Critical Risk</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time Period</label>
                            <select id="risk-period-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Risk Category</label>
                            <select id="risk-category-filter" class="border border-gray-300 rounded px-3 py-2 text-sm">
                                <option value="all">All Categories</option>
                                <option value="yield">Yield Risk</option>
                                <option value="quality">Quality Risk</option>
                                <option value="process">Process Risk</option>
                                <option value="equipment">Equipment Risk</option>
                            </select>
                        </div>
                        <button id="refresh-risk-assessment" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                            üîÑ Refresh Assessment
                        </button>
                    </div>
                </div>

                <!-- Risk Overview Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-green-100 rounded-lg">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Low Risk</p>
                                <p id="low-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-yellow-100 rounded-lg">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Medium Risk</p>
                                <p id="medium-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-orange-100 rounded-lg">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">High Risk</p>
                                <p id="high-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow border">
                        <div class="flex items-center">
                            <div class="p-2 bg-red-100 rounded-lg">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-500">Critical Risk</p>
                                <p id="critical-risk-count" class="text-2xl font-bold text-gray-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Risk Analysis Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Risk Trend Analysis -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Risk Trend Analysis</h3>
                        <div class="h-64">
                            <canvas id="risk-trend-chart"></canvas>
                        </div>
                    </div>

                    <!-- Risk Distribution -->
                    <div class="bg-white p-6 rounded-lg shadow border">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üéØ Risk Distribution</h3>
                        <div class="h-64">
                            <canvas id="risk-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Risk Details Table -->
                <div class="bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üìã Risk Assessment Details</h3>
                    </div>
                    <div class="">
                        <table id="risk-details-table" class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Level</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Probability</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Impact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="risk-details-tbody" class="bg-white divide-y divide-gray-200">
                                <!-- Risk rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Risk Mitigation Recommendations -->
                <div class="mt-6 bg-white rounded-lg shadow border">
                    <div class="p-6 border-b">
                        <h3 class="text-lg font-semibold text-gray-800">üí° Risk Mitigation Recommendations</h3>
                    </div>
                    <div id="risk-mitigation" class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Immediate Actions -->
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-red-800 mb-2">üö® Immediate Actions Required</h4>
                                <div id="immediate-actions" class="space-y-2">
                                    <!-- Immediate actions will be populated here -->
                                </div>
                            </div>
                            
                            <!-- Preventive Measures -->
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">üõ°Ô∏è Preventive Measures</h4>
                                <div id="preventive-measures" class="space-y-2">
                                    <!-- Preventive measures will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Final Test Tab -->
            <div id="final-test-tab" class="tab-content hidden">
                <!-- File Upload Section -->
                <div class="mb-4">
                    <button id="uploadBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                        ÌååÏùº ÏÑ†ÌÉù Î∞è ÏóÖÎ°úÎìú
                    </button>
                    <button id="debugBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded ml-2">
                        üîç Debug Sequences
                    </button>
                    <button id="debugDataBtn" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded ml-2">
                        üî¨ Debug Parsed Data
                    </button>
                </div>

                <!-- File Input -->
                <div class="mb-6">
                    <label class="block mb-2 font-semibold">Final Test Summary ÌååÏùº ÏóÖÎ°úÎìú (.lotSumTXT)</label>
                    <input type="file" id="final-test-upload" accept=".lotSumTXT" multiple class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                    <p class="text-xs text-slate-500 mt-1">Ïó¨Îü¨ Final Test ÏöîÏïΩ ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                </div>

                <!-- Loading State -->
                <div id="final-test-loading" class="hidden text-center py-8">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-slate-600">ÌååÏùºÏùÑ Î∂ÑÏÑù Ï§ëÏûÖÎãàÎã§...</p>
                </div>

                <!-- Results Section -->
                <div id="final-test-result" class="hidden">
                    <!-- Multi-File Summary -->
                    <div id="multi-file-summary" class="mb-6 p-4 bg-blue-50 rounded-lg">
                        <h2 class="text-lg font-bold mb-2 text-blue-800">üìä Multi-File Summary</h2>
                        <div id="file-summary-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4"></div>
                        <div id="aggregated-yield" class="bg-white p-3 rounded shadow">
                            <h3 class="font-semibold mb-2">Aggregated Yield Analysis</h3>
                            <div id="aggregated-stats" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                            <div class="mt-4 flex gap-2">
                                <button id="export-summary" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                                    üìä Export Summary
                                </button>
                                <button id="export-details" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm">
                                    üìã Export Details
                                </button>
                                <button id="export-comparison" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 text-sm">
                                    üìà Export Comparison
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lot Comparison -->
                    <div id="lot-comparison" class="mb-6 p-4 bg-green-50 rounded-lg">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-lg font-bold text-green-800">üìà Lot Comparison</h2>
                            <div class="flex items-center space-x-2">
                                <button id="reset-table-width" class="px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600">
                                    üîÑ Reset Width
                                </button>
                                <button id="fit-content-width" class="px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600">
                                    üìè Fit Content
                                </button>
                                <button id="print-friendly-width" class="px-3 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600">
                                    üñ®Ô∏è Print Width
                                </button>
                            </div>
                        </div>
                        <div id="lot-comparison-table-container" class="bg-white rounded-lg border relative">
                            <div class="resize-handle absolute right-0 top-0 bottom-0 w-1 bg-gray-300 cursor-col-resize hover:bg-blue-400 transition-colors"></div>
                            <div class="overflow-x-auto" style="max-width: 1200px; min-width: 800px;">
                                <table id="lot-comparison-table" class="w-full text-sm table-fixed">
                                    <!-- Table content -->
                                </table>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-600">
                            üí° <strong>Tip:</strong> Drag the right edge to resize table width. Use buttons above for preset widths.
                        </div>
                    </div>
                    
                    <!-- Selected Lot Details Section -->
                    <div id="selected-lot-section" class="mt-6 hidden">
                        <!-- Lot Specific Analytics -->
                        <div class="p-6 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl border border-gray-200 shadow-lg">
                            <h2 class="text-xl font-bold mb-6 text-gray-800 flex items-center">
                                <span class="text-3xl mr-3">üîç</span>
                                Lot Specific Analytics
                            </h2>
                            
                            <!-- Zone 1: Lot Info, Test Summary, Quality Metrics -->
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                                <div id="selected-lot-info"></div>
                                <div id="selected-lot-summary"></div>
                                <div id="selected-lot-quality"></div>
                            </div>
                            
                            <!-- Zone 2: Re-test Flow, Failure Analysis -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div id="selected-lot-retest-flow"></div>
                                <div id="selected-lot-failure-analysis"></div>
                            </div>
                        </div>

                        <!-- Lot Hard Bin Sorting Table -->
                        <div id="hard-bin-table-container" class="mt-6">
                            <div class="bg-white rounded-lg shadow border">
                                <div class="p-6 border-b">
                                    <h3 class="text-lg font-semibold text-gray-800">üìä Hard Bin Sorting Table</h3>
                                </div>
                                <div class="">
                                    <table id="hard-bin-table" class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bin Code</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                            </tr>
                                        </thead>
                                        <tbody id="hard-bin-tbody" class="bg-white divide-y divide-gray-200">
                                            <!-- Hard bin data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Test Results by Site -->
                        <div class="mt-6">
                            <h2 class="text-lg font-bold mb-2 text-gray-700">üìã Test Í≤∞Í≥º ÏÉÅÏÑ∏ (SiteÎ≥Ñ)</h2>
                            <div id="test-stage-tabs" class="border-b border-gray-200 mb-2 flex space-x-4">
                                <!-- Test stage tabs will be injected here -->
                            </div>
                            <div id="test-results-container">
                                <!-- Test results tables will be injected here -->
                            </div>
                        </div>
                    </div>

                    <!-- Aggregated Enhanced Analytics -->
                    <div id="enhanced-analytics" class="mt-6 mb-6 p-4 bg-purple-50 rounded-lg">
                        <h2 class="text-lg font-bold mb-2 text-purple-800">üî¨ Aggregated Enhanced Analytics</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">üìà Yield Trend Analysis</h3>
                                <div id="trend-content"></div>
                            </div>
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">üéØ Failure Pattern Analysis</h3>
                                <div id="pattern-content"></div>
                            </div>
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">üè≠ Site Performance</h3>
                                <div id="site-content"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded shadow">
                                <h3 class="font-semibold mb-2 text-purple-700">üîó Failure Correlation Analysis</h3>
                                <div id="correlation-content"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Debug Information -->
                <div id="debug-info" class="mt-4 p-4 bg-gray-100 rounded text-xs hidden">
                    <h3 class="font-semibold mb-2">Debug Information:</h3>
                    <pre id="debug-content"></pre>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript Modules -->
    <script>
        // Global variables
        let uploadedFiles = [];
        let parsedData = [];
        let analysisResults = {};

        // STDF Parser Class
        class STDFParser {
            constructor() {
                this.records = [];
                this.lotInfo = {};
                this.testResults = [];
                this.binningData = [];
                this.parametricData = [];
            }

            async parseSTDFFile(file) {
                try {
                    console.log('Parsing STDF file:', file.name);
                    
                    // Read file as ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const uint8Array = new Uint8Array(arrayBuffer);
                    
                    // Check if file is compressed
                    if (file.name.endsWith('.gz')) {
                        const decompressed = pako.inflate(uint8Array);
                        return this.parseSTDFData(decompressed, file.name);
                    } else {
                        return this.parseSTDFData(uint8Array, file.name);
                    }
                } catch (error) {
                    console.error('Error parsing STDF file:', error);
                    throw new Error(`Failed to parse STDF file: ${error.message}`);
                }
            }

            parseSTDFData(data, fileName) {
                try {
                    // Basic STDF parsing implementation
                    // This is a simplified version - in production, you'd use a full STDF parser
                    
                    const result = {
                        fileName: fileName,
                        lotInfo: {
                            lotNumber: this.extractLotNumber(fileName),
                            device: this.extractDevice(fileName),
                            testDate: new Date().toISOString(),
                            operator: 'Unknown'
                        },
                        summary: {
                            totalRecords: 0,
                            totalSites: 0,
                            totalPass: 0,
                            totalFail: 0,
                            yield: 0
                        },
                        testResults: [],
                        binningData: [],
                        parametricData: [],
                        analytics: {
                            yieldBySite: {},
                            failurePatterns: [],
                            statisticalData: {}
                        }
                    };

                    // Simulate STDF parsing results
                    // In a real implementation, you would parse the actual STDF binary data
                    result.summary.totalRecords = Math.floor(Math.random() * 10000) + 1000;
                    result.summary.totalSites = Math.floor(Math.random() * 100) + 50;
                    result.summary.totalPass = Math.floor(Math.random() * result.summary.totalSites);
                    result.summary.totalFail = result.summary.totalSites - result.summary.totalPass;
                    result.summary.yield = (result.summary.totalPass / result.summary.totalSites * 100).toFixed(2);

                    // Generate sample test results
                    result.testResults = this.generateSampleTestResults(result.summary.totalSites);
                    
                    // Generate sample binning data
                    result.binningData = this.generateSampleBinningData();
                    
                    // Generate sample parametric data
                    result.parametricData = this.generateSampleParametricData();

                    return result;
                } catch (error) {
                    console.error('Error parsing STDF data:', error);
                    throw new Error(`Failed to parse STDF data: ${error.message}`);
                }
            }

            extractLotNumber(fileName) {
                // Extract lot number from filename
                const match = fileName.match(/([A-Z0-9]+)/);
                return match ? match[1] : 'Unknown';
            }

            extractDevice(fileName) {
                // Extract device name from filename
                const match = fileName.match(/([A-Z0-9]+)/g);
                return match && match.length > 1 ? match[1] : 'Unknown';
            }

            generateSampleTestResults(totalSites) {
                const results = [];
                const testTypes = ['DC_Test', 'AC_Test', 'Functional_Test', 'Parametric_Test'];
                
                for (let i = 0; i < testTypes.length; i++) {
                    const passCount = Math.floor(Math.random() * totalSites);
                    const failCount = totalSites - passCount;
                    
                    results.push({
                        test: testTypes[i],
                        result: passCount > failCount ? 'PASS' : 'FAIL',
                        time: Math.random() * 100,
                        site1: Math.floor(passCount * 0.25),
                        site2: Math.floor(passCount * 0.25),
                        site3: Math.floor(passCount * 0.25),
                        site4: Math.floor(passCount * 0.25),
                        total: passCount
                    });
                }
                
                return results;
            }

            generateSampleBinningData() {
                const bins = [];
                const binTypes = ['Pass', 'Fail', 'Skip', 'Retest'];
                
                for (let i = 0; i < binTypes.length; i++) {
                    bins.push({
                        bin: i + 1,
                        type: binTypes[i],
                        count: Math.floor(Math.random() * 100) + 10,
                        percentage: Math.random() * 100
                    });
                }
                
                return bins;
            }

            generateSampleParametricData() {
                const parametric = [];
                const parameters = ['IDDQ', 'Vt', 'Freq', 'Leakage'];
                
                for (let i = 0; i < parameters.length; i++) {
                    parametric.push({
                        parameter: parameters[i],
                        min: Math.random() * 10,
                        max: Math.random() * 10 + 10,
                        mean: Math.random() * 10 + 5,
                        std: Math.random() * 2,
                        unit: i === 0 ? 'mA' : i === 1 ? 'V' : i === 2 ? 'MHz' : 'nA'
                    });
                }
                
                return parametric;
            }
        }

        // File Upload Handler
        class FileUploadHandler {
            constructor() {
                this.parser = new STDFParser();
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                const fileInput = document.getElementById('stdf-file-upload');
                const analyzeBtn = document.getElementById('analyze-all-files');
                const clearBtn = document.getElementById('clear-all-files');
                const exportBtn = document.getElementById('export-analysis');

                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileSelection(e));
                }

                if (analyzeBtn) {
                    analyzeBtn.addEventListener('click', () => this.analyzeAllFiles());
                }

                if (clearBtn) {
                    clearBtn.addEventListener('click', () => this.clearAllFiles());
                }

                if (exportBtn) {
                    exportBtn.addEventListener('click', () => this.exportAnalysis());
                }

                // Drag and drop functionality
                const uploadArea = document.querySelector('#file-upload-tab .border-dashed');
                if (uploadArea) {
                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('border-blue-400', 'bg-blue-50');
                    });

                    uploadArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('border-blue-400', 'bg-blue-50');
                        const files = Array.from(e.dataTransfer.files);
                        this.processFiles(files);
                    });
                }
            }

            handleFileSelection(event) {
                const files = Array.from(event.target.files);
                this.processFiles(files);
            }

            async processFiles(files) {
                const stdfFiles = files.filter(file => 
                    file.name.endsWith('.stdf') || file.name.endsWith('.stdf.gz')
                );

                if (stdfFiles.length === 0) {
                    alert('Please select valid STDF files (.stdf or .stdf.gz)');
                    return;
                }

                this.showUploadProgress();
                this.addFilesToList(stdfFiles);

                for (const file of stdfFiles) {
                    try {
                        await this.processFile(file);
                    } catch (error) {
                        console.error('Error processing file:', file.name, error);
                        this.updateFileStatus(file.name, 'error', error.message);
                    }
                }

                this.hideUploadProgress();
                this.showAnalysisControls();
                this.updateSummaryStats();
            }

            async processFile(file) {
                this.updateFileStatus(file.name, 'processing', 'Parsing STDF file...');
                
                try {
                    const result = await this.parser.parseSTDFFile(file);
                    uploadedFiles.push({ file, result });
                    parsedData.push(result);
                    
                    this.updateFileStatus(file.name, 'success', 'Parsed successfully');
                    console.log('File processed successfully:', file.name, result);
                } catch (error) {
                    this.updateFileStatus(file.name, 'error', error.message);
                    throw error;
                }
            }

            showUploadProgress() {
                const progressDiv = document.getElementById('upload-progress');
                if (progressDiv) {
                    progressDiv.classList.remove('hidden');
                }
            }

            hideUploadProgress() {
                const progressDiv = document.getElementById('upload-progress');
                if (progressDiv) {
                    progressDiv.classList.add('hidden');
                }
            }

            addFilesToList(files) {
                const fileList = document.getElementById('file-list');
                const uploadedFilesDiv = document.getElementById('uploaded-files');
                
                if (fileList) {
                    fileList.classList.remove('hidden');
                }

                if (uploadedFilesDiv) {
                    uploadedFilesDiv.innerHTML = '';
                    
                    files.forEach(file => {
                        const fileItem = this.createFileItem(file);
                        uploadedFilesDiv.appendChild(fileItem);
                    });
                }
            }

            createFileItem(file) {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-4 bg-gray-50 rounded-lg';
                div.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-file-code text-blue-500"></i>
                        <div>
                            <p class="font-medium text-gray-900">${file.name}</p>
                            <p class="text-sm text-gray-500">${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span id="status-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}" class="text-sm text-gray-500">Pending</span>
                        <div id="progress-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}" class="hidden">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        </div>
                    </div>
                `;
                return div;
            }

            updateFileStatus(fileName, status, message) {
                const statusId = `status-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const progressId = `progress-${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                const statusElement = document.getElementById(statusId);
                const progressElement = document.getElementById(progressId);
                
                if (statusElement) {
                    statusElement.textContent = message;
                    statusElement.className = 'text-sm';
                    
                    switch (status) {
                        case 'processing':
                            statusElement.classList.add('text-blue-600');
                            if (progressElement) progressElement.classList.remove('hidden');
                            break;
                        case 'success':
                            statusElement.classList.add('text-green-600');
                            if (progressElement) progressElement.classList.add('hidden');
                            break;
                        case 'error':
                            statusElement.classList.add('text-red-600');
                            if (progressElement) progressElement.classList.add('hidden');
                            break;
                    }
                }
            }

            showAnalysisControls() {
                const controlsDiv = document.getElementById('analysis-controls');
                if (controlsDiv) {
                    controlsDiv.classList.remove('hidden');
                }
            }

            updateSummaryStats() {
                const totalFiles = document.getElementById('summary-total-files');
                const totalLots = document.getElementById('summary-total-lots');
                const overallYield = document.getElementById('summary-overall-yield');
                const lastUpdated = document.getElementById('summary-last-updated');

                if (totalFiles) totalFiles.textContent = uploadedFiles.length;
                if (totalLots) totalLots.textContent = parsedData.length;
                
                if (parsedData.length > 0) {
                    const avgYield = parsedData.reduce((sum, data) => 
                        sum + parseFloat(data.summary.yield), 0) / parsedData.length;
                    if (overallYield) overallYield.textContent = avgYield.toFixed(2) + '%';
                }
                
                if (lastUpdated) lastUpdated.textContent = new Date().toLocaleTimeString();
            }

            async analyzeAllFiles() {
                if (parsedData.length === 0) {
                    alert('No files to analyze. Please upload STDF files first.');
                    return;
                }

                console.log('Starting analysis of', parsedData.length, 'files');
                
                // Perform comprehensive analysis
                analysisResults = this.performComprehensiveAnalysis(parsedData);
                
                // Update UI with analysis results
                this.updateAnalysisUI();
                
                // Update charts with new data
                if (chartManager) {
                    chartManager.updateChartsWithData(analysisResults);
                }
                
                // Switch to summary tab to show results
                this.switchToTab('summary');
                
                console.log('Analysis completed:', analysisResults);
            }

            performComprehensiveAnalysis(data) {
                const results = {
                    overall: {
                        totalFiles: data.length,
                        totalLots: data.length,
                        averageYield: 0,
                        totalRecords: 0,
                        totalSites: 0
                    },
                    yieldAnalysis: {},
                    testAnalysis: {},
                    binningAnalysis: {},
                    parametricAnalysis: {},
                    patterns: []
                };

                // Calculate overall statistics
                let totalYield = 0;
                let totalRecords = 0;
                let totalSites = 0;

                data.forEach(item => {
                    totalYield += parseFloat(item.summary.yield);
                    totalRecords += item.summary.totalRecords;
                    totalSites += item.summary.totalSites;
                });

                results.overall.averageYield = totalYield / data.length;
                results.overall.totalRecords = totalRecords;
                results.overall.totalSites = totalSites;

                // Analyze yield patterns
                results.yieldAnalysis = this.analyzeYieldPatterns(data);
                
                // Analyze test results
                results.testAnalysis = this.analyzeTestResults(data);
                
                // Analyze binning data
                results.binningAnalysis = this.analyzeBinningData(data);
                
                // Analyze parametric data
                results.parametricAnalysis = this.analyzeParametricData(data);

                return results;
            }

            analyzeYieldPatterns(data) {
                const yields = data.map(item => parseFloat(item.summary.yield));
                return {
                    min: Math.min(...yields),
                    max: Math.max(...yields),
                    average: yields.reduce((a, b) => a + b, 0) / yields.length,
                    distribution: this.calculateDistribution(yields)
                };
            }

            analyzeTestResults(data) {
                const allTests = [];
                data.forEach(item => {
                    if (item.testResults) {
                        allTests.push(...item.testResults);
                    }
                });

                const testSummary = {};
                allTests.forEach(test => {
                    if (!testSummary[test.test]) {
                        testSummary[test.test] = {
                            total: 0,
                            pass: 0,
                            fail: 0,
                            yield: 0
                        };
                    }
                    testSummary[test.test].total += test.total;
                    testSummary[test.test].pass += test.total;
                    testSummary[test.test].yield = (testSummary[test.test].pass / testSummary[test.test].total * 100).toFixed(2);
                });

                return testSummary;
            }

            analyzeBinningData(data) {
                const allBins = [];
                data.forEach(item => {
                    if (item.binningData) {
                        allBins.push(...item.binningData);
                    }
                });

                const binSummary = {};
                allBins.forEach(bin => {
                    if (!binSummary[bin.type]) {
                        binSummary[bin.type] = {
                            total: 0,
                            percentage: 0
                        };
                    }
                    binSummary[bin.type].total += bin.count;
                });

                const totalBins = Object.values(binSummary).reduce((sum, bin) => sum + bin.total, 0);
                Object.values(binSummary).forEach(bin => {
                    bin.percentage = (bin.total / totalBins * 100).toFixed(2);
                });

                return binSummary;
            }

            analyzeParametricData(data) {
                const allParametric = [];
                data.forEach(item => {
                    if (item.parametricData) {
                        allParametric.push(...item.parametricData);
                    }
                });

                const parametricSummary = {};
                allParametric.forEach(param => {
                    if (!parametricSummary[param.parameter]) {
                        parametricSummary[param.parameter] = {
                            min: param.min,
                            max: param.max,
                            mean: param.mean,
                            std: param.std,
                            unit: param.unit
                        };
                    } else {
                        parametricSummary[param.parameter].min = Math.min(parametricSummary[param.parameter].min, param.min);
                        parametricSummary[param.parameter].max = Math.max(parametricSummary[param.parameter].max, param.max);
                        parametricSummary[param.parameter].mean = (parametricSummary[param.parameter].mean + param.mean) / 2;
                    }
                });

                return parametricSummary;
            }

            calculateDistribution(values) {
                const sorted = values.sort((a, b) => a - b);
                return {
                    q1: sorted[Math.floor(sorted.length * 0.25)],
                    median: sorted[Math.floor(sorted.length * 0.5)],
                    q3: sorted[Math.floor(sorted.length * 0.75)]
                };
            }

            updateAnalysisUI() {
                // Update summary statistics
                this.updateSummaryStats();
                
                // Update recent results
                this.updateRecentResults();
                
                // Update analysis tabs
                this.updateAnalysisTabs();
            }

            updateRecentResults() {
                const recentResults = document.getElementById('recent-results');
                if (recentResults && analysisResults.overall) {
                    recentResults.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-blue-800">Overall Yield</h4>
                                <p class="text-2xl font-bold text-blue-600">${analysisResults.overall.averageYield.toFixed(2)}%</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-green-800">Total Records</h4>
                                <p class="text-2xl font-bold text-green-600">${analysisResults.overall.totalRecords.toLocaleString()}</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-purple-800">Total Sites</h4>
                                <p class="text-2xl font-bold text-purple-600">${analysisResults.overall.totalSites.toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                }
            }

            updateAnalysisTabs() {
                // This will be implemented when we add the analysis tab functionality
                console.log('Analysis tabs updated with results:', analysisResults);
            }

            clearAllFiles() {
                uploadedFiles = [];
                parsedData = [];
                analysisResults = {};
                
                const fileInput = document.getElementById('stdf-file-upload');
                if (fileInput) fileInput.value = '';
                
                const fileList = document.getElementById('file-list');
                const uploadProgress = document.getElementById('upload-progress');
                const analysisControls = document.getElementById('analysis-controls');
                
                if (fileList) fileList.classList.add('hidden');
                if (uploadProgress) uploadProgress.classList.add('hidden');
                if (analysisControls) analysisControls.classList.add('hidden');
                
                this.updateSummaryStats();
                this.updateRecentResults();
            }

            exportAnalysis() {
                if (!analysisResults.overall) {
                    alert('No analysis results to export. Please analyze files first.');
                    return;
                }

                const exportData = {
                    timestamp: new Date().toISOString(),
                    analysis: analysisResults,
                    files: uploadedFiles.map(f => f.file.name)
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stdf-analysis-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            switchToTab(tabName) {
                const tabButtons = document.querySelectorAll('.main-tab');
                const tabContents = document.querySelectorAll('.tab-content');
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                tabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                
                const targetButton = document.querySelector(`[data-tab="${tabName}"]`);
                const targetContent = document.getElementById(`${tabName}-tab`);
                
                if (targetButton && targetContent) {
                    targetButton.classList.add('active', 'border-blue-500', 'text-blue-600');
                    targetButton.classList.remove('border-transparent', 'text-gray-500');
                    targetContent.classList.remove('hidden');
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize file upload handler
            const fileHandler = new FileUploadHandler();
            
            // Initialize chart manager
            chartManager = new ChartManager();
            
            // Initialize tab switching
            initializeTabSwitching();
            
            // Initialize sample charts with placeholder data
            setTimeout(() => {
                if (chartManager) {
                    chartManager.createRiskTrendChart();
                    chartManager.createRiskDistributionChart();
                }
            }, 1000);
            
            console.log('CP/EDS STDF Analytics Dashboard initialized with chart support');
        });

        // Tab switching logic
        function initializeTabSwitching() {
            const tabButtons = document.querySelectorAll('.main-tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Remove active class from all tabs
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
                        btn.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.add('active', 'border-blue-500', 'text-blue-600');
                    this.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Hide all tab contents
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target tab content
                    const targetContent = document.getElementById(`${targetTab}-tab`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Navigation function
        function goBack() {
            window.location.href = 'wafer map dashboard v5.0-integrated.html';
        }

        // Chart Management Class
        class ChartManager {
            constructor() {
                this.charts = {};
            }

            createYieldTrendChart(data) {
                const ctx = document.getElementById('test-yield-chart');
                if (!ctx || !data) return;

                if (this.charts.yieldTrend) {
                    this.charts.yieldTrend.destroy();
                }

                this.charts.yieldTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.lotId),
                        datasets: [{
                            label: 'Yield (%)',
                            data: data.map(d => d.yield),
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Yield (%)'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Lot ID'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            createParametricDistributionChart(parametricData) {
                const ctx = document.getElementById('test-failure-chart');
                if (!ctx || !parametricData) return;

                if (this.charts.parametricDistribution) {
                    this.charts.parametricDistribution.destroy();
                }

                const parameters = Object.keys(parametricData);
                const datasets = parameters.slice(0, 5).map((param, index) => ({
                    label: param,
                    data: [parametricData[param].mean],
                    backgroundColor: `hsla(${index * 60}, 70%, 50%, 0.8)`
                }));

                this.charts.parametricDistribution = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Mean Values'],
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Value'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            }

            createHardBinChart(binData) {
                const ctx = document.getElementById('bin-distribution-chart');
                if (!ctx || !binData) return;

                if (this.charts.hardBin) {
                    this.charts.hardBin.destroy();
                }

                const labels = binData.map(bin => `Bin ${bin.bin}`);
                const data = binData.map(bin => bin.count);
                const colors = binData.map((bin, index) => 
                    bin.bin === 1 ? '#10b981' : `hsla(${index * 30}, 70%, 50%, 0.8)`
                );

                this.charts.hardBin = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createSoftBinChart(binData) {
                const ctx = document.getElementById('bin-trend-chart');
                if (!ctx || !binData) return;

                if (this.charts.softBin) {
                    this.charts.softBin.destroy();
                }

                const labels = binData.map(bin => `SBin ${bin.bin}`);
                const data = binData.map(bin => bin.count);
                const colors = binData.map((bin, index) => 
                    bin.bin === 1 ? '#3b82f6' : `hsla(${index * 40 + 200}, 70%, 50%, 0.8)`
                );

                this.charts.softBin = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            createRiskTrendChart() {
                const ctx = document.getElementById('risk-trend-chart');
                if (!ctx) return;

                if (this.charts.riskTrend) {
                    this.charts.riskTrend.destroy();
                }

                // Sample risk trend data
                const dates = [];
                const riskScores = [];
                for (let i = 7; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toLocaleDateString());
                    riskScores.push(Math.random() * 40 + 30); // Random risk scores 30-70
                }

                this.charts.riskTrend = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [{
                            label: 'Risk Score',
                            data: riskScores,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Risk Score'
                                }
                            }
                        }
                    }
                });
            }

            createRiskDistributionChart() {
                const ctx = document.getElementById('risk-distribution-chart');
                if (!ctx) return;

                if (this.charts.riskDistribution) {
                    this.charts.riskDistribution.destroy();
                }

                this.charts.riskDistribution = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Low Risk', 'Medium Risk', 'High Risk', 'Critical Risk'],
                        datasets: [{
                            data: [45, 30, 20, 5],
                            backgroundColor: [
                                '#10b981', // Green
                                '#f59e0b', // Yellow
                                '#f97316', // Orange
                                '#ef4444'  // Red
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            }

            updateChartsWithData(analysisData) {
                if (!analysisData) return;

                // Prepare data for charts
                const yieldData = parsedData.map(item => ({
                    lotId: item.summary?.lotId || 'Unknown',
                    yield: item.summary?.yield || 0
                }));

                const parametricData = this.aggregateParametricData();
                const hardBinData = this.aggregateBinData('hard');
                const softBinData = this.aggregateBinData('soft');

                // Create/update charts
                this.createYieldTrendChart(yieldData);
                this.createParametricDistributionChart(parametricData);
                this.createHardBinChart(hardBinData);
                this.createSoftBinChart(softBinData);
                this.createRiskTrendChart();
                this.createRiskDistributionChart();
            }

            aggregateParametricData() {
                const allParametric = {};
                parsedData.forEach(item => {
                    if (item.parametricData) {
                        item.parametricData.forEach(param => {
                            if (!allParametric[param.parameter]) {
                                allParametric[param.parameter] = {
                                    mean: param.mean,
                                    min: param.min,
                                    max: param.max,
                                    unit: param.unit
                                };
                            }
                        });
                    }
                });
                return allParametric;
            }

            aggregateBinData(type) {
                const binCounts = {};
                parsedData.forEach(item => {
                    const binData = type === 'hard' ? item.binningData?.hardBins : item.binningData?.softBins;
                    if (binData) {
                        binData.forEach(bin => {
                            binCounts[bin.bin] = (binCounts[bin.bin] || 0) + bin.count;
                        });
                    }
                });

                return Object.entries(binCounts).map(([bin, count]) => ({
                    bin: parseInt(bin),
                    count: count
                }));
            }
        }

        // Global chart manager instance
        let chartManager = null;

        // Report generation function  
        function generateReport() {
            if (!analysisResults.overall) {
                alert('No analysis results available. Please upload and analyze STDF files first.');
                return;
            }
            
            // Enhanced PDF report generation using jsPDF
            if (typeof jsPDF !== 'undefined') {
                generatePDFReport();
            } else {
                // Fallback - JSON export
                const exportData = {
                    timestamp: new Date().toISOString(),
                    analysis: analysisResults,
                    files: uploadedFiles.map(f => f.file.name)
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cp-stdf-analysis-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        async function generatePDFReport() {
            if (!analysisResults.overall) {
                alert('No analysis results available. Please upload and analyze STDF files first.');
                return;
            }

            try {
                // Show loading indicator
                const loadingIndicator = document.createElement('div');
                loadingIndicator.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                        <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                            <div style="margin-bottom: 15px;">Generating PDF Report...</div>
                            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        </div>
                    </div>
                `;
                loadingIndicator.innerHTML += `<style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>`;
                document.body.appendChild(loadingIndicator);

                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                let yPosition = 20;

                // Add title
                pdf.setFontSize(20);
                pdf.setFont('helvetica', 'bold');
                pdf.text('CP/EDS STDF Analysis Report', pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 15;

                // Add generation date
                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                pdf.text(`Generated on: ${new Date().toLocaleString()}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 20;

                // Add summary statistics
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Analysis Summary', 20, yPosition);
                yPosition += 10;

                pdf.setFontSize(12);
                pdf.setFont('helvetica', 'normal');
                const summaryText = [
                    `Total Files Analyzed: ${uploadedFiles.length}`,
                    `Overall Yield: ${analysisResults.overall.averageYield.toFixed(2)}%`,
                    `Total Records: ${analysisResults.overall.totalRecords.toLocaleString()}`,
                    `Total Sites: ${analysisResults.overall.totalSites}`,
                    `Analysis Date: ${new Date().toLocaleDateString()}`
                ];

                summaryText.forEach(text => {
                    pdf.text(text, 25, yPosition);
                    yPosition += 7;
                });

                yPosition += 10;

                // Add file details
                pdf.setFontSize(16);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Analyzed Files', 20, yPosition);
                yPosition += 10;

                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'normal');
                uploadedFiles.forEach((fileData, index) => {
                    if (yPosition > pageHeight - 20) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    const fileInfo = parsedData[index];
                    pdf.text(`${index + 1}. ${fileData.file.name}`, 25, yPosition);
                    yPosition += 5;
                    
                    if (fileInfo && fileInfo.summary) {
                        pdf.text(`   Lot ID: ${fileInfo.summary.lotId || 'Unknown'}`, 30, yPosition);
                        yPosition += 4;
                        pdf.text(`   Yield: ${fileInfo.summary.yield?.toFixed(2) || 'N/A'}%`, 30, yPosition);
                        yPosition += 4;
                        pdf.text(`   Records: ${fileInfo.summary.totalRecords || 0}`, 30, yPosition);
                        yPosition += 4;
                    }
                    yPosition += 3;
                });

                // Add charts (capture and embed)
                if (chartManager && chartManager.charts) {
                    yPosition += 10;
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'bold');
                    
                    if (yPosition > pageHeight - 60) {
                        pdf.addPage();
                        yPosition = 20;
                    }
                    
                    pdf.text('Chart Analysis', 20, yPosition);
                    yPosition += 15;

                    // Try to capture charts as images
                    const chartIds = ['test-yield-chart', 'test-failure-chart', 'bin-distribution-chart', 'bin-trend-chart'];
                    
                    for (const chartId of chartIds) {
                        const chartElement = document.getElementById(chartId);
                        if (chartElement && chartManager.charts[chartId.replace('-', '')]) {
                            try {
                                // Create a temporary container for the chart
                                const tempCanvas = document.createElement('canvas');
                                tempCanvas.width = 400;
                                tempCanvas.height = 200;
                                
                                // Get chart as base64 image
                                const chart = chartManager.charts[chartId.replace('-', '')];
                                if (chart) {
                                    const imageData = chart.toBase64Image();
                                    
                                    if (yPosition > pageHeight - 80) {
                                        pdf.addPage();
                                        yPosition = 20;
                                    }
                                    
                                    // Add chart title
                                    pdf.setFontSize(12);
                                    pdf.setFont('helvetica', 'bold');
                                    const chartTitle = chartId.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
                                    pdf.text(chartTitle, 20, yPosition);
                                    yPosition += 10;
                                    
                                    // Add chart image
                                    pdf.addImage(imageData, 'PNG', 20, yPosition, 160, 60);
                                    yPosition += 70;
                                }
                            } catch (error) {
                                console.warn(`Could not capture chart ${chartId}:`, error);
                            }
                        }
                    }
                }

                // Add footer
                const totalPages = pdf.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    pdf.setPage(i);
                    pdf.setFontSize(8);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(`Page ${i} of ${totalPages}`, pageWidth - 30, pageHeight - 10);
                    pdf.text('Generated by Semiconductor Value Chain ERP', 20, pageHeight - 10);
                }

                // Save the PDF
                const fileName = `cp-stdf-analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                // Remove loading indicator
                document.body.removeChild(loadingIndicator);

                // Show success message
                alert('PDF report generated successfully!');

            } catch (error) {
                console.error('Error generating PDF report:', error);
                alert('Error generating PDF report. Please try again.');
                
                // Remove loading indicator if it exists
                const loadingIndicator = document.querySelector('div[style*="position: fixed"]');
                if (loadingIndicator) {
                    document.body.removeChild(loadingIndicator.parentElement);
                }
            }
        }
    </script>
</body>
</html>